var varioscale=function(){"use strict";function t(t,e,r){function n(a){if(!o)if((a=_())>=i+e)t.call(r,1);else{var s=(a-i)/e;t.call(r,s),b(n)}}if(!e)return t.call(r,1),null;var o=!1,i=_();return b(n),function(){o=!0}}function e(t){function e(a){a.preventDefault(),o.removeEventListener("mousedown",e,{passive:!1}),o.addEventListener("mousemove",r,{passive:!1}),o.addEventListener("mouseup",n,{passive:!1});var s=o.getBoundingClientRect(),u=a.touches?a.touches[0]:a,l=u.clientX-s.left-o.clientLeft,h=u.clientY-s.top-o.clientTop;i=new y([l,h]),t.panBy(0,0)}function r(e){e.preventDefault();var r=o.getBoundingClientRect(),n=e.touches?e.touches[0]:e,a=n.clientX-r.left-o.clientLeft,s=n.clientY-r.top-o.clientTop,u=i.last()[1],l=a-u[0],h=s-u[1];i.shift(200),i.push([a,s]),t.panBy(l,h)}function n(a){o.removeEventListener("mousemove",r,{passive:!1}),o.removeEventListener("mouseup",n,{passive:!1}),o.addEventListener("mousedown",e,{passive:!1});var s=o.getBoundingClientRect(),u=a.changedTouches?a.changedTouches[0]:a,l=u.clientX-s.left-o.clientLeft,h=u.clientY-s.top-o.clientTop;i.shift(200),i.push([l,h]);var c=i.last(),f=i.first(),p=(c[0]-f[0])/1e3,v=f[1],d=l-v[0],m=h-v[1],g=d/p*1,_=m/p*1,w=parseFloat(document.getElementById("panduration").value),b=.5*g*(w/1e3),y=.5*_*(w/1e3);i=null,t.panAnimated(b,y)}var o=t.getCanvasContainer();o.addEventListener("mousedown",e,{passive:!1}),o.oncontextmenu=function(t){t.preventDefault()};var i=null}function r(t){function e(t){t.preventDefault();var e=_();if(!(e-i<20)){var a=void 0;if("wheel"===t.type?a=t.deltaY:"mousewheel"===t.type&&(a=-t.wheelDeltaY),0!==a){i=e;var s=.1,u=Math.max(-1,Math.min(1,-a));if(null===o)o=new y(u);else{var l=o.last(),h=e-l[0];o.push(u);for(var c=document.getElementsByName("speed"),f=1,p=0,v=c.length;p<v;p++)if(c[p].checked){f=parseFloat(c[p].value);break}switch(h){case h>750:s=.0625;break;case h>500:s=.125;break;case h>50:s=.25;break;default:s=.5}s*=f,o.shift(2e3)}var d=n.getBoundingClientRect(),m=t.clientX-d.left,g=t.clientY-d.top;switch(u){case 1:r.zoomInAnimated(m,g,s);break;case-1:r.zoomOutAnimated(m,g,s)}}}}var r=t,n=t.getCanvasContainer();n.addEventListener("wheel",e,{passive:!1}),n.addEventListener("mousewheel",e,{passive:!1});var o=null,i=null}function n(t){function e(t){var e=n(t),r=e[0],o=e[1];return Math.sqrt(r*r,o*o)}function r(t){var e=n(t),r=e[0],o=e[1],i=t[0];return[i[0]+r/2,i[1]+o/2]}function n(t){return[t[1][0]-t[0][0],t[1][1]-t[0][1]]}function o(t){for(var e=u.getBoundingClientRect(),r=t.touches,n=[],o=0;o<2;o++){var i=r[o].clientX-e.left-u.clientLeft,a=r[o].clientY-e.top-u.clientTop;n.push([i,a])}return n}function i(e){if(e.touches&&2===e.touches.length){e.preventDefault(),u.removeEventListener("touchstart",i,!1),u.addEventListener("touchmove",a,{capture:!0,passive:!1}),u.addEventListener("touchend",s,!1),l=null,h=_(),console.log("start touch with 2 fingers "+h),t.abortAndRender();var r=o(e);c=new y(r)}}function a(n){if(n.touches&&2===n.touches.length&&!(_()-h<30)){console.log("time of touch "+(_()-h)),n.preventDefault();var i=o(n);c.shift(200),c.push(i);var a=e(i);if(null!==l){var s=a/l,u=r(i),f=u[0],p=u[1];t.zoom(f,p,Math.max(Math.min(s,1.1),.9))}l=a}}function s(n){if(0===n.touches.length){if(n.preventDefault(),console.log("end"),u.removeEventListener("touchmove",a,{capture:!0,passive:!1}),u.removeEventListener("touchend",s,!1),u.addEventListener("touchstart",i,!1),l=null,h=null,console.log("trace for pinch end "+c.length()),c.length()>1){var o=c.last(),f=c.lastbutone(),p=e(o[1]),v=e(f[1]),d=r(o[1]),m=d[0],g=d[1];p<v?t.zoomOutAnimated(m,g,.5):t.zoomInAnimated(m,g,.5)}c=null}}var u=t.getCanvasContainer();u.addEventListener("touchstart",i,!1),u.oncontextmenu=function(t){t.preventDefault()};var l=null,h=null,c=null}function o(t){function e(t){var e=i.getBoundingClientRect(),r=t.touches;return[r[0].clientX-e.left-i.clientLeft,r[0].clientY-e.top-i.clientTop]}function r(t){if(!(t.touches.length>1)){t.preventDefault(),i.removeEventListener("touchstart",r,!1),i.addEventListener("touchmove",n,{capture:!0,passive:!1}),i.addEventListener("touchend",o,!1);var u=e(t);console.log("touchstart"),a=new y(u),s="pending"}}function n(r){if(r.touches.length>1)return void(s="pending");r.preventDefault();var n=e(r),o=a.last()[1],i=n[0]-o[0],u=n[1]-o[1];switch(a.shift(200),a.push(n),s){case"pending":(Math.sqrt(i*i,u*u)>=3||a.last()[0]-a.first()[0]>60)&&(s="active");break;case"active":t.panBy(i,u)}}function o(e){if(0===e.touches.length){switch(i.removeEventListener("touchmove",n,{capture:!0,passive:!1}),i.removeEventListener("touchend",o,!1),i.addEventListener("touchstart",r,!1),a.shift(200),a.length()<=2&&(s="pending"),s){case"pending":console.log("touch drag end - SKIP");break;case"active":var u=a.last(),l=a.first(),h=(u[0]-l[0])/1e3,c=l[1],f=u[1][0]-c[0],p=u[1][1]-c[1],v=f/h*1,d=p/h*1,m=parseFloat(document.getElementById("panduration").value),g=.5*v*(m/1e3),_=.5*d*(m/1e3);console.log("touch drag end - ANIMATE"),console.log([g,_]),t.panAnimated(g,_)}s="pending",a=null,console.log("touchend")}}var i=t.getCanvasContainer();i.addEventListener("touchstart",r,!1),i.oncontextmenu=function(t){t.preventDefault()};var a=null,s=null}function i(t,e,r){var n=e[0],o=e[1],i=e[2],a=r[3]*n+r[7]*o+r[11]*i+r[15];return a=a||1,t[0]=(r[0]*n+r[4]*o+r[8]*i+r[12])/a,t[1]=(r[1]*n+r[5]*o+r[9]*i+r[13])/a,t[2]=(r[2]*n+r[6]*o+r[10]*i+r[14])/a,t}function a(){var t=new Float32Array(3);return t[0]=0,t[1]=0,t[2]=0,t}function s(){var t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function u(t,e){var r=e[0],n=e[1],o=e[2],i=e[3],a=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=e[9],f=e[10],p=e[11],v=e[12],d=e[13],m=e[14],g=e[15],_=r*s-n*a,w=r*u-o*a,b=r*l-i*a,y=n*u-o*s,x=n*l-i*s,E=o*l-i*u,A=h*d-c*v,T=h*m-f*v,R=h*g-p*v,B=c*m-f*d,L=c*g-p*d,P=f*g-p*m,C=_*P-w*L+b*B+y*R-x*T+E*A;return C?(C=1/C,t[0]=(s*P-u*L+l*B)*C,t[1]=(o*L-n*P-i*B)*C,t[2]=(d*E-m*x+g*y)*C,t[3]=(f*x-c*E-p*y)*C,t[4]=(u*R-a*P-l*T)*C,t[5]=(r*P-o*R+i*T)*C,t[6]=(m*b-v*E-g*w)*C,t[7]=(h*E-f*b+p*w)*C,t[8]=(a*L-s*R+l*A)*C,t[9]=(n*R-r*L-i*A)*C,t[10]=(v*x-d*b+g*_)*C,t[11]=(c*b-h*x-p*_)*C,t[12]=(s*T-a*B-u*A)*C,t[13]=(r*B-n*T+o*A)*C,t[14]=(d*w-v*y-m*_)*C,t[15]=(h*y-c*w+f*_)*C,t):null}function l(t,e,r){var n=e[0],o=e[1],i=e[2],a=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],f=e[9],p=e[10],v=e[11],d=e[12],m=e[13],g=e[14],_=e[15],w=r[0],b=r[1],y=r[2],x=r[3];return t[0]=w*n+b*s+y*c+x*d,t[1]=w*o+b*u+y*f+x*m,t[2]=w*i+b*l+y*p+x*g,t[3]=w*a+b*h+y*v+x*_,w=r[4],b=r[5],y=r[6],x=r[7],t[4]=w*n+b*s+y*c+x*d,t[5]=w*o+b*u+y*f+x*m,t[6]=w*i+b*l+y*p+x*g,t[7]=w*a+b*h+y*v+x*_,w=r[8],b=r[9],y=r[10],x=r[11],t[8]=w*n+b*s+y*c+x*d,t[9]=w*o+b*u+y*f+x*m,t[10]=w*i+b*l+y*p+x*g,t[11]=w*a+b*h+y*v+x*_,w=r[12],b=r[13],y=r[14],x=r[15],t[12]=w*n+b*s+y*c+x*d,t[13]=w*o+b*u+y*f+x*m,t[14]=w*i+b*l+y*p+x*g,t[15]=w*a+b*h+y*v+x*_,t}function h(t){var e=.5*(t.xmax-t.xmin),r=.5*(t.ymax-t.ymin),n=.5*(t.xmax+t.xmin),o=.5*(t.ymax+t.ymin),i=s();return i[0]=e,i[5]=r,i[12]=n,i[13]=o,i}function c(t,e){for(var r=[],n=[t];n.length>0;)!function(){var t=n.pop();t.children.forEach(function(r){p(t.box,e)&&n.push(r)}),t.dataelements.forEach(function(t){p(t.box,e)&&r.push(t)})}();return r}function f(t){for(var e=[],r=[t];r.length>0;){var n=r.pop();n.children.forEach(function(t){r.push(t)}),n.dataelements.forEach(function(t){e.push(t)})}return e}function p(t,e){for(var r=!0,n=0;n<3;n++){var o=n+3;if(t[o]<e[n]||t[n]>e[o]){r=!1;break}}return r}function v(){var t={2101:{r:239,g:200,b:200},2112:{r:255,g:174,b:185},2114:{r:204,g:204,b:204},2201:{r:138,g:211,b:175},2202:{r:51,g:204,b:153},2213:{r:170,g:203,b:175},2230:{r:181,g:227,b:181},2301:{r:157,g:157,b:108},3103:{r:254,g:254,b:254},3302:{r:204,g:153,b:255},4101:{r:234,g:216,b:189},4102:{r:230,g:255,b:204},4103:{r:171,g:223,b:150},4104:{r:255,g:255,b:192},4105:{r:40,g:200,b:254},4107:{r:141,g:197,b:108},4108:{r:174,g:209,b:160},4109:{r:207,g:236,b:168},4111:{r:190,g:239,b:255},5112:{r:181,g:208,b:208}};for(var e in t){var r=t[e];r.r_frac=r.r/255,r.g_frac=r.g/255,r.b_frac=r.b/255}return t}function d(t,e){var r=e||0,n=q;return[n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]]].join("")}function m(){for(var t=new Array(16),e=0,r=void 0;e<16;e++)0==(3&e)&&(r=4294967296*Math.random()),t[e]=r>>>((3&e)<<3)&255;return t}function g(){return d(m())}var _=function(){return window.performance&&window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date)}(),w=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,b=function(t){return w(t)},y=(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame,function(t){this._trace=[],this.push(t)});y.prototype.shift=function(t){for(var e=this,r=_();this._trace.length>0&&r-this._trace[0][0]>t;)e._trace.shift()},y.prototype.push=function(t){var e=_();this._trace.push([e,t])},y.prototype.first=function(){return this._trace[0]},y.prototype.last=function(){return this._trace[this._trace.length-1]},y.prototype.lastbutone=function(){return this._trace[this._trace.length-2]},y.prototype.length=function(){return this._trace.length};var x=l,E=function(t,e,r,n){this.xmin=t,this.ymin=e,this.xmax=r,this.ymax=n};E.prototype.width=function(){return this.xmax-this.xmin},E.prototype.height=function(){return this.ymax-this.ymin},E.prototype.toString=function(){return"new Rectangle("+this.xmin+", "+this.ymin+", "+this.xmax+", "+this.ymax+")"},E.prototype.area=function(){return this.width()*this.height()},E.prototype.center=function(){return[this.xmin+.5*this.width(),this.ymin+.5*this.height()]};var A=function(t,e,r,n,o,i){this.Sb=t,this.Nb=e,this.Ns=r,this.viewport_world=s(),this.world_viewport=s(),this.world_square=null,this.square_viewport=null,this.viewport=null,this.initTransform(n,o,i)};A.prototype.initTransform=function(t,e,r){var n=t[0],o=t[1],i=e[0],a=e[1],u=.5*i,l=.5*a,c=[u/3779.5275590551*r,l/3779.5275590551*r],f=n-c[0],p=n+c[0],v=o-c[1],d=o+c[1];this.viewport=new E(0,0,i,a);var m=new E(f,v,p,d),g=[2/m.width(),2/m.height()],_=[-g[0]*n,-g[1]*o],w=s();w[0]=g[0],w[5]=g[1],w[12]=_[0],w[13]=_[1],this.world_square=w,this.square_viewport=h(this.viewport),this.updateViewportTransform()},A.prototype.backward=function(t){var e=a();return i(e,t,this.viewport_world),e},A.prototype.updateViewportTransform=function(){x(this.world_viewport,this.square_viewport,this.world_square),u(this.viewport_world,this.world_viewport)},A.prototype.pan=function(t,e){this.square_viewport[12]+=t,this.square_viewport[13]+=e,x(this.world_viewport,this.square_viewport,this.world_square),u(this.viewport_world,this.world_viewport);var r=this.visibleWorld(),n=r.center(),o=[2/r.width(),2/r.height()],i=[-o[0]*n[0],-o[1]*n[1]],a=s();a[0]=o[0],a[5]=o[1],a[12]=i[0],a[13]=i[1],this.world_square=a,this.square_viewport=h(this.viewport),this.updateViewportTransform()},A.prototype.zoom=function(t,e,r){var n=s(),o=s();o[12]=-e,o[13]=-r,x(n,o,this.square_viewport);var i=s();i[0]=t,i[5]=t,x(n,i,n);var a=s();a[12]=e,a[13]=r,x(n,a,n),this.square_viewport=n,x(this.world_viewport,this.square_viewport,this.world_square),u(this.viewport_world,this.world_viewport);var l=this.visibleWorld(),c=l.center(),f=[2/l.width(),2/l.height()],p=[-f[0]*c[0],-f[1]*c[1]],v=s();v[0]=f[0],v[5]=f[1],v[12]=p[0],v[13]=p[1],this.world_square=v,this.square_viewport=h(this.viewport),this.updateViewportTransform()},A.prototype.visibleWorld=function(){var t=this.backward([this.viewport.xmin,this.viewport.ymin,0]),e=this.backward([this.viewport.xmax,this.viewport.ymax,0]);return new E(t[0],t[1],e[0],e[1])},A.prototype.getCenter=function(){return this.backward([this.viewport.xmin+.5*(this.viewport.xmax-this.viewport.xmin),this.viewport.ymin+.5*(this.viewport.ymax-this.viewport.ymin),0])},A.prototype.getScaleDenominator=function(){var t=new E(0,0,this.viewport.width()/3779.5275590551,this.viewport.height()/3779.5275590551),e=this.visibleWorld();return Math.sqrt(e.area()/t.area())},A.prototype.stepMap=function(){var t=new E(0,0,this.viewport.width()/3779.5275590551,this.viewport.height()/3779.5275590551),e=this.visibleWorld(),r=Math.sqrt(e.area()/t.area()),n=1-Math.pow(this.Sb/r,2),o=(this.Ns+1)*n;return[Math.max(0,o),r]};var T=function(t,e,r){function n(t,e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error("ERROR occurred while compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}var o=n(t,t.VERTEX_SHADER,e),i=n(t,t.FRAGMENT_SHADER,r),a=t.createProgram();return t.attachShader(a,o),t.attachShader(a,i),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)?(t.validateProgram(a),t.getProgramParameter(a,t.VALIDATE_STATUS)?(this.shaderProgram=a,void(this.gl=t)):void console.error("ERROR validating program!",t.getProgramInfoLog(a))):void console.error("ERROR linking program!",t.getProgramInfoLog(a))};T.prototype._prepare_vertices=function(t,e,r,n,o,i){var a=t.getAttribLocation(e,r);t.enableVertexAttribArray(a),t.vertexAttribPointer(a,n,t.FLOAT,!1,o,i)};var R=function(t){function e(e){this.colors=[[141,211,199],[190,186,218],[251,128,114],[128,177,211],[253,180,98],[179,222,105],[252,205,229],[217,217,217],[188,128,189],[204,235,197]].map(function(t){return[t[0]/255,t[1]/255,t[2]/255]});t.call(this,e,"\nprecision highp float;\n\nattribute vec2 displacement;\nattribute vec4 vertexPosition_modelspace;\nuniform mat4 M;\nuniform float near;\nuniform float half_width_reality;\n\nvoid main()\n{\n    vec4 pos = vertexPosition_modelspace;\n\n    if (pos.z <= near && pos.w > near)\n    {\n        pos.x +=  displacement.x * half_width_reality;\n        pos.y +=  displacement.y * half_width_reality;\n        gl_Position = M * vec4(pos.xyz, 1.0);\n\n    } else {\n        gl_Position = vec4(-10.0,-10.0,-10.0,1.0);\n        return;\n    }\n}\n","\nprecision mediump float;\nuniform vec4 uColor;\n\nvoid main()\n{\n    gl_FragColor = uColor; // color of the lines\n}\n")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e,r,n){var o=this.gl,i=this.shaderProgram,a=e.content.line_triangleVertexPosBufr,s=e.content.displacementBuffer;if(null!==a){o.useProgram(i),o.bindBuffer(o.ARRAY_BUFFER,a),this._prepare_vertices(o,i,"vertexPosition_modelspace",4,0,0),o.bindBuffer(o.ARRAY_BUFFER,s),this._prepare_vertices(o,i,"displacement",2,0,0);var u=parseFloat(document.getElementById("boundary_width_slider").value),l=u*r[1]/1e3/2;n>0&&(l*=n);var h=o.getUniformLocation(i,"M");o.uniformMatrix4fv(h,!1,t);var c=o.getUniformLocation(i,"near");o.uniform1f(c,r[0]);var f=o.getUniformLocation(i,"half_width_reality");if(o.uniform1f(f,l),n>0)var p=[0,0,0];else var p=[1,1,1];var v=o.getUniformLocation(i,"uColor");o.uniform4f(v,p[0],p[1],p[2],1),o.enable(o.BLEND),o.disable(o.DEPTH_TEST),o.drawArrays(o.TRIANGLES,0,a.numItems)}},e}(T),B=function(t){function e(e){t.call(this,e,"\nprecision highp float;\n\nattribute vec3 vertexPosition_modelspace;\nattribute vec4 vertexColor;\nuniform mat4 M;\nvarying vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vertexColor;\n    gl_Position = M * vec4(vertexPosition_modelspace, 1);\n}\n","\nprecision mediump float;\n\nvarying vec4 fragColor;\nvoid main()\n{\n    gl_FragColor = vec4(fragColor);\n}\n")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e){var r=this.gl,n=this.shaderProgram;r.useProgram(n);var o=e.content.polygon_triangleVertexPosBufr;if(null!==o){r.bindBuffer(r.ARRAY_BUFFER,o),this._prepare_vertices(r,n,"vertexPosition_modelspace",3,24,0),this._prepare_vertices(r,n,"vertexColor",3,24,12);var i=r.getUniformLocation(n,"M");r.uniformMatrix4fv(i,!1,t),r.disable(r.BLEND),r.enable(r.DEPTH_TEST),r.drawArrays(r.TRIANGLES,0,o.numItems)}},e}(T),L=function(t,e){this.gl=t,this.ssctree=e};L.prototype.render_relevant_tiles=function(t,e,r,n){var o=this.ssctree.get_relevant_tiles(e);if(o.length>0){var i=new B(this.gl);o.forEach(function(e){i.draw_tile(t,e)});var a=new R(this.gl);o.forEach(function(e){a.draw_tile(t,e,r,2),a.draw_tile(t,e,r,0)})}},L.prototype.setViewport=function(t,e){this.gl.viewport(0,0,t,e)};var P=function(t){this.msgbus=t,this.tree=null,this.retrieved={}};P.prototype.load=function(){var t=this;fetch("data/tree_buchholz.json").then(function(t){return t.json()}).then(function(e){t.tree=e;var r=e.box;e.center2d=[(r[0]+r[3])/2,(r[1]+r[4])/2],f(t.tree).forEach(function(t){t.content=null,t.last_touched=null,t.url="data/"+t.info})}).then(function(){t.msgbus.publish("data.tree.loaded","tree.ready")}).catch(function(t){console.error(t)})},P.prototype.fetch_tiles=function(t,e){var r=this;if(null!==this.tree){c(this.tree,t).map(function(t){if(!r.retrieved[t.url]&&null===t.content){var n=new C(r.msgbus);n.load(t.url,e),t.content=n,r.retrieved[t.url]=!0}})}},P.prototype.get_relevant_tiles=function(t){return null===this.tree?[]:c(this.tree,t).filter(function(e){return null!==e.content&&p(t,e.box)}).map(function(t){return t.last_touched=_(),t})};var C=function(t){this.msgbus=t,this.line_triangleVertexPosBufr=null,this.displacementBuffer=null,this.polygon_triangleVertexPosBufr=null};C.prototype.load=function(t,e){var r=this;fetch(t).then(function(t){return t.text()}).then(function(t){var n=r._obtain_data_from_text(t,e,r.class_color_dt);r.line_triangleVertexPosBufr=n[0],r.displacementBuffer=n[1],r.polygon_triangleVertexPosBufr=n[2],r.msgbus.publish("data.tile.loaded","tile.ready")}).catch(function(t){console.error(t)})},C.prototype._obtain_data_from_text=function(t,e){var r=v(),n=[],o=this._obtain_line_and_polygon_triangleVertexPosBufr(t,e,r,n),i=new Float32Array(n.flat(1)),a=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),a.itemSize=2,a.numItems=i.length/2,[o[0],a,o[1]]},C.prototype._obtain_line_and_polygon_triangleVertexPosBufr=function(t,e,r,n){var o=this,i=[],a=[],s=[],u=[],l=[];t.split("\n").forEach(function(t){return o._parseLine(t,a,r,u,i,s,l,n)});var h=new Float32Array(l.flat(1)),c=this._obtain_triangleVertexPosBufr(e,h,4,4),f=new Float32Array(u);return[c,this._obtain_triangleVertexPosBufr(e,f,3,6)]},C.prototype._obtain_triangleVertexPosBufr=function(t,e,r,n){var o=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),o.itemSize=r,o.numItems=e.length/n,o},C.prototype._parseLine=function(t,e,r,n,o,i,a,s){function u(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]-e[n])}else for(var n=0;n<t.length;n++)r.push(t[n]-e);return r}function l(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]+e[n])}else for(var n=0;n<t.length;n++)r.push(t[n]+e);return r}function h(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]*e[n])}else for(var n=0;n<t.length;n++)r.push(t[n]*e);return r}function c(t,e){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var r=0,n=0;n<t.length;n++)r+=t[n]*e[n];return r}function f(t){return c(t,t)}function p(t){return[-t[1],t[0]]}function v(t){return[t[1],-t[0]]}var d=t.split(" ");if("v"==d[0])e.push({x:Number(d[1]),y:Number(d[2]),z:Number(d[3])});else if("g"==d[0]){var m=Number(d[1].split("_")[0]);i[0]=r[m]}else if("f"==d[0]){var g=i[0];for(b=1;b<=3;b++){var _=e[Number(d[b])-1];n.push(_.x,_.y,_.z,g.r_frac,g.g_frac,g.b_frac)}}else if("#"==d[0])d.length>1&&(o[0]=d[1]);else if("l"==d[0]){for(var w=[],b=1;b<d.length;b++)w.push(e[d[b]-1]);for(var y=[],x=0;x<w.length;x++){var E=w[x];y.push([E.x,E.y,E.z,o[0]])}for(var x=0;x<y.length-1;x++){var A=y[x],T=y[x+1],R=A.slice(0,2),B=T.slice(0,2),L=function(t,e){return u(e,t)}(R,B),P=function(t){return Math.sqrt(f(t))}(L);if(0!=P){var C=function(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]/e[n])}else for(var n=0;n<t.length;n++)r.push(t[n]/e);return r}(L,P),q=l(h(C,-1),v(C)),F=l(h(C,-1),p(C)),S=l(C,v(C)),M=l(C,p(C));a.push(A,A,T,A,T,T),s.push(F,q,M,q,S,M)}}}};for(var q=[],F=0;F<256;++F)q[F]=(F+256).toString(16).substr(1);var S=function(){this._topics={}};S.prototype.publish=function(t,e,r){return null===r&&(r=0),!!this._topics[t]&&(this._topics[t].forEach(function(n){setTimeout(n(t,e,r),0)}),!0)},S.prototype.subscribe=function(t,e){var r=this;return this._topics[t]||(this._topics[t]=[]),this._topics[t].push(e),{remove:function(){var n=r._topics[t].indexOf(e);r._topics[t].splice(n,1),0===r._topics[t].length&&delete r._topics[t]}}};var M=new S;Object.freeze(M);var V=function(){this.id=g()};V.prototype.publish=function(t,e){return M.publish(t,e,this.id)},V.prototype.subscribe=function(t,e){return M.subscribe(t,e)};var I=function(t){var i=this;if(this._container="string"==typeof t?window.document.getElementById(t):t,!this._container)throw new Error("Container '"+t+"' not found.");var a=this.getCanvasContainer().getBoundingClientRect();this.rect=a,this._abort=null,this.msgbus=new V,this.msgbus.subscribe("data.tile.loaded",function(t,e,r){null===i._abort&&i.panAnimated(0,0)}),this.msgbus.subscribe("data.tree.loaded",function(t,e,r){var n=i.ssctree.tree;i._transform=new A(n.start_scale_Sb,n.no_of_objects_Nb,n.no_of_steps_Ns,n.center2d,[a.width,a.height],n.view_scale_Sv);var o=i.getTransform().stepMap();i._prepare_active_tiles(o[0])}),this.msgbus.subscribe("map.scale",function(t,e,r){var n=(5*Math.round(e/5)).toString().replace(/\B(?=(\d{3})+(?!\d))/g," ");document.getElementById("scale-denominator").textContent=" 1:"+n}),this.ssctree=new P(this.msgbus),this.ssctree.load(),this.renderer=new L(this._container.getContext("experimental-webgl",{alpha:!1,antialias:!0}),this.ssctree),this.renderer.setViewport(a.width,a.height),e(this),r(this),n(this),o(this)};return I.prototype.getCanvasContainer=function(){return this._container},I.prototype.getTransform=function(){return this._transform},I.prototype.render=function(){var t=this.getTransform().stepMap();this.msgbus.publish("map.scale",t[1]);var e=this._prepare_active_tiles(t[0]);this.renderer.render_relevant_tiles(e[0],e[1],t)},I.prototype._prepare_active_tiles=function(t){var e=this.getTransform().world_square;e[10]=-2/(t- -1),e[14]=(t+-1)/(t- -1);var r=this.getTransform().visibleWorld(),n=[r.xmin,r.ymin,t,r.xmax,r.ymax,t],o=this._container.getContext("experimental-webgl",{alpha:!1,antialias:!0});return this.ssctree.fetch_tiles(n,o),[e,n]},I.prototype.doEaseNone=function(t,e){var r=this;return function(n){for(var o=new Float32Array(16),i=0;i<16;i++){var a=t[i]+n*(e[i]-t[i]);o[i]=a}r.getTransform().world_square=o,r.getTransform().updateViewportTransform(),r.render(),1==n&&(r._abort=null)}},I.prototype.doEaseInOutSine=function(t,e){function r(r){for(var n=new Float32Array(16),o=Math.cos(Math.PI*r)-1,i=0;i<16;i++){var a=e[i]-t[i],s=.5*-a*o+t[i];n[i]=s}this.getTransform().world_square=n,this.getTransform().updateViewportTransform(),this.render(),1==r&&(this._abort=null)}return r},I.prototype.doEaseOutSine=function(t,e){var r=this;return function(n){for(var o=new Float32Array(16),i=Math.sin(n*(.5*Math.PI)),a=0;a<16;a++){var s=e[a]-t[a],u=s*i+t[a];o[a]=u}r.getTransform().world_square=o,r.getTransform().updateViewportTransform(),r.render(),1===n&&(r._abort=null)}},I.prototype.doEaseOutQuint=function(t,e){function r(r){for(var n=r-1,o=Math.pow(n,5)+1,i=new Float32Array(16),a=0;a<16;a++){var s=e[a]-t[a],u=s*o+t[a];i[a]=u}this.getTransform().world_square=i,this.getTransform().updateViewportTransform(),this.render(),1==r&&(this._abort=null)}return r},I.prototype.animateZoom=function(t,e,r){var n=this.getTransform().world_square;this.getTransform().zoom(r,t,this.rect.height-e);var o=this.getTransform().world_square;return this.doEaseOutSine(n,o)},I.prototype.animatePan=function(t,e){var r=this.getTransform().world_square;this.getTransform().pan(t,-e);var n=this.getTransform().world_square;return this.doEaseOutSine(r,n)},I.prototype.panBy=function(t,e){null!==this._abort&&this._abort(),this.getTransform().pan(t,-e),this.render()},I.prototype.zoom=function(t,e,r){this.getTransform().zoom(r,t,this.rect.height-e),this.render()},I.prototype.abortAndRender=function(){null!==this._abort&&(this._abort(),this._abort=null),this.getTransform().pan(0,0),this.render()},I.prototype.zoomInAnimated=function(t,e,r){this.zoomAnimated(t,e,1+r)},I.prototype.zoomOutAnimated=function(t,e,r){this.zoomAnimated(t,e,1/(1+r))},I.prototype.zoomAnimated=function(e,r,n){null!==this._abort&&this._abort();var o=this.animateZoom(e,r,n),i=parseFloat(document.getElementById("duration").value);this._abort=t(o,i,this)},I.prototype.panAnimated=function(e,r){null!==this._abort&&this._abort();var n=parseFloat(document.getElementById("panduration").value),o=this.animatePan(e,r);this._abort=t(o,n,this)},I.prototype.resize=function(t,e){var r=this.getTransform(),n=r.getCenter(),o=r.getScaleDenominator();r.initTransform(n,[t,e],o),this.renderer.setViewport(t,e)},{Map:I}}();
//# sourceMappingURL=index.js.map
