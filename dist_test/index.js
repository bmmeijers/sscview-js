var varioscale=function(){"use strict";function t(t,e,r){function n(a){if(!o)if((a=y())>=i+e)t.call(r,1);else{var s=(a-i)/e;t.call(r,s),x(n)}}if(!e)return t.call(r,1),null;var o=!1,i=y();return x(n),function(){o=!0}}function e(t){function e(a){a.preventDefault(),o.removeEventListener("mousedown",e,{passive:!1}),o.addEventListener("mousemove",r,{passive:!1}),o.addEventListener("mouseup",n,{passive:!1});var s=o.getBoundingClientRect(),u=a.touches?a.touches[0]:a,l=u.clientX-s.left-o.clientLeft,h=u.clientY-s.top-o.clientTop;i=new E([l,h]),t.panBy(0,0)}function r(e){e.preventDefault();var r=o.getBoundingClientRect(),n=e.touches?e.touches[0]:e,a=n.clientX-r.left-o.clientLeft,s=n.clientY-r.top-o.clientTop,u=i.last()[1],l=a-u[0],h=s-u[1];i.shift(200),i.push([a,s]),t.panBy(l,h)}function n(a){o.removeEventListener("mousemove",r,{passive:!1}),o.removeEventListener("mouseup",n,{passive:!1}),o.addEventListener("mousedown",e,{passive:!1});var s=o.getBoundingClientRect(),u=a.changedTouches?a.changedTouches[0]:a,l=u.clientX-s.left-o.clientLeft,h=u.clientY-s.top-o.clientTop;i.shift(200),i.push([l,h]);var c=i.last(),f=i.first(),p=(c[0]-f[0])/1e3,d=f[1],v=l-d[0],m=h-d[1],g=v/p*1,_=m/p*1,w=parseFloat(t._interaction_settings.pan_duration),b=.5*g*(w/1e3),y=.5*_*(w/1e3);i=null,t.panAnimated(b,y)}var o=t.getCanvasContainer();o.addEventListener("mousedown",e,{passive:!1}),o.oncontextmenu=function(t){t.preventDefault()};var i=null}function r(t){function e(t){t.preventDefault();var e=y();if(!(e-i<20)){var a=void 0;if("wheel"===t.type?a=t.deltaY:"mousewheel"===t.type&&(a=-t.wheelDeltaY),0!==a){i=e;var s=.1,u=Math.max(-1,Math.min(1,-a));if(null===o)o=new E(u);else{var l=o.last(),h=e-l[0];o.push(u);switch(h){case h>750:s=.0625;break;case h>500:s=.125;break;case h>50:s=.25;break;default:s=.5}s*=1,o.shift(2e3)}var c=n.getBoundingClientRect(),f=t.clientX-c.left-n.clientLeft,p=t.clientY-c.top-n.clientTop;switch(u){case 1:r.zoomInAnimated(f,p,s);break;case-1:r.zoomOutAnimated(f,p,s)}}}}var r=t,n=t.getCanvasContainer();n.addEventListener("wheel",e,{passive:!1}),n.addEventListener("mousewheel",e,{passive:!1});var o=null,i=null}function n(t){function e(t){var e=n(t),r=e[0],o=e[1];return Math.sqrt(r*r,o*o)}function r(t){var e=n(t),r=e[0],o=e[1],i=t[0];return[i[0]+r/2,i[1]+o/2]}function n(t){return[t[1][0]-t[0][0],t[1][1]-t[0][1]]}function o(t){for(var e=u.getBoundingClientRect(),r=t.touches,n=[],o=0;o<2;o++){var i=r[o].clientX-e.left-u.clientLeft,a=r[o].clientY-e.top-u.clientTop;n.push([i,a])}return n}function i(e){if(e.touches&&2===e.touches.length){e.preventDefault(),u.removeEventListener("touchstart",i,!1),u.addEventListener("touchmove",a,{capture:!0,passive:!1}),u.addEventListener("touchend",s,!1),l=null,h=y(),console.log("start touch with 2 fingers "+h),t.abortAndRender();var r=o(e);c=new E(r)}}function a(n){if(n.touches&&2===n.touches.length&&!(y()-h<30)){console.log("time of touch "+(y()-h)),n.preventDefault();var i=o(n);c.shift(200),c.push(i);var a=e(i);if(null!==l){var s=a/l,u=r(i),f=u[0],p=u[1];t.zoom(f,p,Math.max(Math.min(s,1.1),.9))}l=a}}function s(n){if(0===n.touches.length){if(n.preventDefault(),console.log("end"),u.removeEventListener("touchmove",a,{capture:!0,passive:!1}),u.removeEventListener("touchend",s,!1),u.addEventListener("touchstart",i,!1),l=null,h=null,console.log("trace for pinch end "+c.length()),c.length()>1){var o=c.last(),f=c.lastbutone(),p=e(o[1]),d=e(f[1]),v=r(o[1]),m=v[0],g=v[1];p<d?t.zoomOutAnimated(m,g,.5):t.zoomInAnimated(m,g,.5)}c=null}}var u=t.getCanvasContainer();u.addEventListener("touchstart",i,!1),u.oncontextmenu=function(t){t.preventDefault()};var l=null,h=null,c=null}function o(t){function e(t){var e=i.getBoundingClientRect(),r=t.touches;return[r[0].clientX-e.left-i.clientLeft,r[0].clientY-e.top-i.clientTop]}function r(t){if(!(t.touches.length>1)){t.preventDefault(),i.removeEventListener("touchstart",r,!1),i.addEventListener("touchmove",n,{capture:!0,passive:!1}),i.addEventListener("touchend",o,!1);var u=e(t);console.log("touchstart"),a=new E(u),s="pending"}}function n(r){if(r.touches.length>1)return void(s="pending");r.preventDefault();var n=e(r),o=a.last()[1],i=n[0]-o[0],u=n[1]-o[1];switch(a.shift(200),a.push(n),s){case"pending":(Math.sqrt(i*i,u*u)>=3||a.last()[0]-a.first()[0]>60)&&(s="active");break;case"active":t.panBy(i,u)}}function o(e){if(0===e.touches.length){switch(i.removeEventListener("touchmove",n,{capture:!0,passive:!1}),i.removeEventListener("touchend",o,!1),i.addEventListener("touchstart",r,!1),a.shift(200),a.length()<=2&&(s="pending"),s){case"pending":console.log("touch drag end - SKIP");break;case"active":var u=a.last(),l=a.first(),h=(u[0]-l[0])/1e3,c=l[1],f=u[1][0]-c[0],p=u[1][1]-c[1],d=f/h*1,v=p/h*1,m=parseFloat(document.getElementById("panduration").value),g=.5*d*(m/1e3),_=.5*v*(m/1e3);console.log("touch drag end - ANIMATE"),console.log([g,_]),t.panAnimated(g,_)}s="pending",a=null,console.log("touchend")}}var i=t.getCanvasContainer();i.addEventListener("touchstart",r,!1),i.oncontextmenu=function(t){t.preventDefault()};var a=null,s=null}function i(t,e,r){var n=e[0],o=e[1],i=e[2],a=r[3]*n+r[7]*o+r[11]*i+r[15];return a=a||1,t[0]=(r[0]*n+r[4]*o+r[8]*i+r[12])/a,t[1]=(r[1]*n+r[5]*o+r[9]*i+r[13])/a,t[2]=(r[2]*n+r[6]*o+r[10]*i+r[14])/a,t}function a(){var t=new Float32Array(3);return t[0]=0,t[1]=0,t[2]=0,t}function s(){var t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function u(t,e){var r=e[0],n=e[1],o=e[2],i=e[3],a=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=e[9],f=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],_=r*s-n*a,w=r*u-o*a,b=r*l-i*a,y=n*u-o*s,T=n*l-i*s,x=o*l-i*u,E=h*v-c*d,A=h*m-f*d,R=h*g-p*d,B=c*m-f*v,C=c*g-p*v,P=f*g-p*m,F=_*P-w*C+b*B+y*R-T*A+x*E;return F?(F=1/F,t[0]=(s*P-u*C+l*B)*F,t[1]=(o*C-n*P-i*B)*F,t[2]=(v*x-m*T+g*y)*F,t[3]=(f*T-c*x-p*y)*F,t[4]=(u*R-a*P-l*A)*F,t[5]=(r*P-o*R+i*A)*F,t[6]=(m*b-d*x-g*w)*F,t[7]=(h*x-f*b+p*w)*F,t[8]=(a*C-s*R+l*E)*F,t[9]=(n*R-r*C-i*E)*F,t[10]=(d*T-v*b+g*_)*F,t[11]=(c*b-h*T-p*_)*F,t[12]=(s*A-a*B-u*E)*F,t[13]=(r*B-n*A+o*E)*F,t[14]=(v*w-d*y-m*_)*F,t[15]=(h*y-c*w+f*_)*F,t):null}function l(t,e,r){var n=e[0],o=e[1],i=e[2],a=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],f=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],_=e[15],w=r[0],b=r[1],y=r[2],T=r[3];return t[0]=w*n+b*s+y*c+T*v,t[1]=w*o+b*u+y*f+T*m,t[2]=w*i+b*l+y*p+T*g,t[3]=w*a+b*h+y*d+T*_,w=r[4],b=r[5],y=r[6],T=r[7],t[4]=w*n+b*s+y*c+T*v,t[5]=w*o+b*u+y*f+T*m,t[6]=w*i+b*l+y*p+T*g,t[7]=w*a+b*h+y*d+T*_,w=r[8],b=r[9],y=r[10],T=r[11],t[8]=w*n+b*s+y*c+T*v,t[9]=w*o+b*u+y*f+T*m,t[10]=w*i+b*l+y*p+T*g,t[11]=w*a+b*h+y*d+T*_,w=r[12],b=r[13],y=r[14],T=r[15],t[12]=w*n+b*s+y*c+T*v,t[13]=w*o+b*u+y*f+T*m,t[14]=w*i+b*l+y*p+T*g,t[15]=w*a+b*h+y*d+T*_,t}function h(t){var e=.5*(t.xmax-t.xmin),r=.5*(t.ymax-t.ymin),n=.5*(t.xmax+t.xmin),o=.5*(t.ymax+t.ymin),i=s();return i[0]=e,i[5]=r,i[12]=n,i[13]=o,i}function c(t){var e=t[0],r=t[1];return[e+.5*(t[3]-e),r+.5*(t[4]-r)]}function f(t,e){var r=c(t),n=c(e),o=Math.pow(n[0]-r[0],2),i=Math.pow(n[1]-r[1],2);return Math.sqrt(o+i)}function p(t,e){for(var r=[],n=[t];n.length>0;)!function(){var t=n.pop();!0===t.hasOwnProperty("children")&&t.children.forEach(function(r){m(t.box,e)&&n.push(r)}),!0===t.hasOwnProperty("dataelements")&&t.dataelements.forEach(function(t){m(t.box,e)&&r.push(t)})}();return r}function d(t,e){for(var r=[],n=[t];n.length>0;){var o=n.pop();!0===o.hasOwnProperty("children")&&o.children.forEach(function(t){t.hasOwnProperty("children")?n.push(t):t.hasOwnProperty("uri")&&!t.hasOwnProperty("loaded")&&m(t.box,e)&&(t.loaded=!0,r.push(t))})}return r}function v(t){for(var e=[],r=[t];r.length>0;){var n=r.pop();!0===n.hasOwnProperty("children")&&n.children.forEach(function(t){r.push(t)}),!0===n.hasOwnProperty("dataelements")&&n.dataelements.forEach(function(t){e.push(t)})}return e}function m(t,e){for(var r=!0,n=0;n<3;n++){var o=n+3;if(t[o]<e[n]||t[n]>e[o]){r=!1;break}}return r}function g(){var t={2101:{r:239,g:200,b:200},2112:{r:255,g:174,b:185},2114:{r:204,g:204,b:204},2201:{r:138,g:211,b:175},2202:{r:51,g:204,b:153},2213:{r:170,g:203,b:175},2230:{r:181,g:227,b:181},2301:{r:157,g:157,b:108},3103:{r:254,g:254,b:254},3302:{r:204,g:153,b:255},4101:{r:234,g:216,b:189},4102:{r:230,g:255,b:204},4103:{r:171,g:223,b:150},4104:{r:255,g:255,b:192},4105:{r:40,g:200,b:254},4107:{r:141,g:197,b:108},4108:{r:174,g:209,b:160},4109:{r:207,g:236,b:168},4111:{r:190,g:239,b:255},5112:{r:181,g:208,b:208}};for(var e in t){var r=t[e];r.r_frac=r.r/255,r.g_frac=r.g/255,r.b_frac=r.b/255}return t}function _(t,e){var r=e||0,n=q;return[n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],"-",n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]],n[t[r++]]].join("")}function w(){for(var t=new Array(16),e=0,r=void 0;e<16;e++)0==(3&e)&&(r=4294967296*Math.random()),t[e]=r>>>((3&e)<<3)&255;return t}function b(){return _(w())}var y=function(){return window.performance&&window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date)}(),T=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,x=function(t){return T(t)},E=(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame,function(t){this._trace=[],this.push(t)});E.prototype.shift=function(t){for(var e=y();this._trace.length>0&&e-this._trace[0][0]>t;)this._trace.shift()},E.prototype.push=function(t){var e=y();this._trace.push([e,t])},E.prototype.first=function(){return this._trace[0]},E.prototype.last=function(){return this._trace[this._trace.length-1]},E.prototype.lastbutone=function(){return this._trace[this._trace.length-2]},E.prototype.length=function(){return this._trace.length};var A=l,R=function(t,e,r,n){this.xmin=t,this.ymin=e,this.xmax=r,this.ymax=n};R.prototype.width=function(){return this.xmax-this.xmin},R.prototype.height=function(){return this.ymax-this.ymin},R.prototype.toString=function(){return"new Rectangle("+this.xmin+", "+this.ymin+", "+this.xmax+", "+this.ymax+")"},R.prototype.area=function(){return this.width()*this.height()},R.prototype.center=function(){return[this.xmin+.5*this.width(),this.ymin+.5*this.height()]};var B=function(t,e,r){this.viewport_world=s(),this.world_viewport=s(),this.world_square=null,this.square_viewport=null,this.viewport=null,this.initTransform(e,[t.width,t.height],r)};B.prototype.initTransform=function(t,e,r){var n=t[0],o=t[1],i=[.5*e[0]/3779.5275590551*r,.5*e[1]/3779.5275590551*r],a=n-i[0],u=n+i[0],l=o-i[1],c=o+i[1];this.viewport=new R(0,0,e[0],e[1]);var f=new R(a,l,u,c),p=[2/f.width(),2/f.height()],d=[-p[0]*n,-p[1]*o],v=s();v[0]=p[0],v[5]=p[1],v[12]=d[0],v[13]=d[1],this.world_square=v,this.square_viewport=h(this.viewport),this.updateViewportTransform()},B.prototype.backward=function(t){var e=a();return i(e,t,this.viewport_world),e},B.prototype.updateViewportTransform=function(){A(this.world_viewport,this.square_viewport,this.world_square),u(this.viewport_world,this.world_viewport)},B.prototype.pan=function(t,e){this.square_viewport[12]+=t,this.square_viewport[13]+=e,A(this.world_viewport,this.square_viewport,this.world_square),u(this.viewport_world,this.world_viewport);var r=this.getVisibleWorld(),n=r.center(),o=[2/r.width(),2/r.height()],i=[-o[0]*n[0],-o[1]*n[1]],a=s();a[0]=o[0],a[5]=o[1],a[12]=i[0],a[13]=i[1],this.world_square=a,this.square_viewport=h(this.viewport),this.updateViewportTransform()},B.prototype.zoom=function(t,e,r){var n=s(),o=s();o[12]=-e,o[13]=-r,A(n,o,this.square_viewport);var i=s();i[0]=t,i[5]=t,A(n,i,n);var a=s();a[12]=e,a[13]=r,A(n,a,n),this.square_viewport=n,A(this.world_viewport,this.square_viewport,this.world_square),u(this.viewport_world,this.world_viewport);var l=this.getVisibleWorld(),c=l.center(),f=[2/l.width(),2/l.height()],p=[-f[0]*c[0],-f[1]*c[1]],d=s();d[0]=f[0],d[5]=f[1],d[12]=p[0],d[13]=p[1],this.world_square=d,this.square_viewport=h(this.viewport),this.updateViewportTransform()},B.prototype.getVisibleWorld=function(){var t=this.backward([this.viewport.xmin,this.viewport.ymin,0]),e=this.backward([this.viewport.xmax,this.viewport.ymax,0]);return new R(t[0],t[1],e[0],e[1])},B.prototype.getCenter=function(){return this.backward([this.viewport.xmin+.5*(this.viewport.xmax-this.viewport.xmin),this.viewport.ymin+.5*(this.viewport.ymax-this.viewport.ymin),0])},B.prototype.getScaleDenominator=function(){var t=new R(0,0,this.viewport.width()/3779.5275590551,this.viewport.height()/3779.5275590551),e=this.getVisibleWorld();return Math.sqrt(e.area()/t.area())};var C=function(t,e,r){function n(t,e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error("ERROR occurred while compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}var o=n(t,t.VERTEX_SHADER,e),i=n(t,t.FRAGMENT_SHADER,r),a=t.createProgram();return t.attachShader(a,o),t.attachShader(a,i),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)?(t.validateProgram(a),t.getProgramParameter(a,t.VALIDATE_STATUS)?(this.shaderProgram=a,void(this.gl=t)):void console.error("ERROR validating program!",t.getProgramInfoLog(a))):void console.error("ERROR linking program!",t.getProgramInfoLog(a))};C.prototype._prepare_vertices=function(t,e,r,n,o,i){var a=t.getAttribLocation(e,r);t.enableVertexAttribArray(a),t.vertexAttribPointer(a,n,t.FLOAT,!1,o,i)};var P=function(t){function e(e){t.call(this,e,"\n            precision highp float;\n\n            attribute vec3 vertexPosition_modelspace;\n            attribute vec2 aTextureCoord;\n\n            uniform mat4 M;\n\n            varying highp vec2 vTextureCoord;\n\n            void main()\n            {\n              gl_Position = M * vec4(vertexPosition_modelspace, 1.0);\n              vTextureCoord = aTextureCoord;\n            }\n        ","\n            precision highp float;\n\n            varying highp vec2 vTextureCoord;\n\n            uniform sampler2D uSampler;\n            \n            void main()\n            {\n              gl_FragColor = texture2D(uSampler, vTextureCoord);\n            }\n        ")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e){if(null!==e.content.buffer){var r=this.gl;r.useProgram(this.shaderProgram),r.bindBuffer(r.ARRAY_BUFFER,e.content.buffer);var n=r.getAttribLocation(this.shaderProgram,"vertexPosition_modelspace");r.vertexAttribPointer(n,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(n);var o=r.getUniformLocation(this.shaderProgram,"M");r.uniformMatrix4fv(o,!1,t),r.bindBuffer(r.ARRAY_BUFFER,e.content.textureCoordBuffer);var i=r.getAttribLocation(this.shaderProgram,"aTextureCoord");r.vertexAttribPointer(i,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(i),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e.content.texture);var a=r.getUniformLocation(this.shaderProgram,"uSampler");r.uniform1i(a,0),r.disable(r.BLEND),r.enable(r.DEPTH_TEST),r.drawArrays(r.TRIANGLES,0,e.content.buffer.numItems)}},e}(C),F=function(t){function e(e){t.call(this,e,"\nprecision highp float;\n\nattribute vec2 displacement;\nattribute vec4 vertexPosition_modelspace;\nuniform mat4 M;\nuniform float near;\nuniform float half_width_reality;\n\nvoid main()\n{\n    vec4 pos = vertexPosition_modelspace;\n\n    if (pos.z <= near && pos.w > near)\n    {\n        pos.x +=  displacement.x * half_width_reality;\n        pos.y +=  displacement.y * half_width_reality;\n        gl_Position = M * vec4(pos.xyz, 1.0);\n\n    } else {\n        gl_Position = vec4(-10.0,-10.0,-10.0,1.0);\n        return;\n    }\n}\n","\nprecision mediump float;\nuniform vec4 uColor;\n\nvoid main()\n{\n    gl_FragColor = uColor; // color of the lines\n}\n"),this.colors=[[141,211,199],[190,186,218],[251,128,114],[128,177,211],[253,180,98],[179,222,105],[252,205,229],[217,217,217],[188,128,189],[204,235,197]].map(function(t){return[t[0]/255,t[1]/255,t[2]/255]})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e,r,n){var o=this.gl,i=this.shaderProgram,a=e.content.line_triangleVertexPosBufr,s=e.content.displacementBuffer;if(null!==a){o.useProgram(i),o.bindBuffer(o.ARRAY_BUFFER,a),this._prepare_vertices(o,i,"vertexPosition_modelspace",4,0,0),o.bindBuffer(o.ARRAY_BUFFER,s),this._prepare_vertices(o,i,"displacement",2,0,0);var u=n*r[1]/1e3/2,l=o.getUniformLocation(i,"M");o.uniformMatrix4fv(l,!1,t);var h=o.getUniformLocation(i,"near");o.uniform1f(h,r[0]);var c=o.getUniformLocation(i,"half_width_reality");o.uniform1f(c,u);var f=[0,0,0],p=o.getUniformLocation(i,"uColor");o.uniform4f(p,f[0],f[1],f[2],1),o.enable(o.BLEND),o.disable(o.DEPTH_TEST),o.drawArrays(o.TRIANGLES,0,a.numItems)}},e}(C),L=function(t){function e(e){t.call(this,e,"\nprecision highp float;\n\nattribute vec3 vertexPosition_modelspace;\nattribute vec4 vertexColor;\nuniform mat4 M;\nvarying vec4 fragColor;\n\nvoid main()\n{\n    fragColor = vertexColor;\n    gl_Position = M * vec4(vertexPosition_modelspace, 1);\n}\n","\nprecision mediump float;\n\nvarying vec4 fragColor;\nvoid main()\n{\n    gl_FragColor = vec4(fragColor);\n}\n")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e){var r=this.gl,n=this.shaderProgram;r.useProgram(n);var o=e.content.polygon_triangleVertexPosBufr;if(null!==o){r.bindBuffer(r.ARRAY_BUFFER,o),this._prepare_vertices(r,n,"vertexPosition_modelspace",3,24,0),this._prepare_vertices(r,n,"vertexColor",3,24,12);var i=r.getUniformLocation(n,"M");r.uniformMatrix4fv(i,!1,t),r.disable(r.BLEND),r.enable(r.DEPTH_TEST),r.drawArrays(r.TRIANGLES,0,o.numItems)}},e}(C),D=function(t,e){this.gl=t,this.ssctree=e,this.settings={boundary_width:.2},this.programs=[new L(this.gl),new F(this.gl),new P(t)]};D.prototype.render_relevant_tiles=function(t,e,r){var n=this,o=this.ssctree.get_relevant_tiles(e);if(this._clear(),o.length>0){var i=this.programs[0];o.forEach(function(e){i.draw_tile(t,e)});var a=this.programs[2];o.filter(function(t){return null!==t.texture}).forEach(function(e){a.draw_tile(t,e)});var s=this.programs[1];o.forEach(function(e){s.draw_tile(t,e,r,n.settings.boundary_width)})}},D.prototype._clear=function(){var t=this.gl;t.clearColor(1,1,1,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},D.prototype.setViewport=function(t,e){this.gl.viewport(0,0,t,e)};var M=function(t,e){this.msgbus=t,this.tree=null,this.settings=e};M.prototype.load=function(){var t=this;fetch(this.settings.tree_root_href+this.settings.tree_root_file_nm).then(function(t){return t.json()}).then(function(e){t.tree=e,v(t.tree).forEach(function(e){e.content=null,e.last_touched=null,e.url=t.settings.tile_root_href+e.info,e.loaded=!1})}).then(function(){t.msgbus.publish("data.tree.loaded","tree.ready")}).catch(function(t){console.error(t)})},M.prototype.load_subtree=function(t){var e=this;fetch(this.settings.tree_root_href+t.uri).then(function(t){return t.json()}).then(function(r){t.children=r.children,v(t).forEach(function(t){t.content=null,t.last_touched=null,t.url=e.settings.tile_root_href+t.info,t.loaded=!1}),e.msgbus.publish("data.tree.loaded","tree.ready")}).catch(function(t){console.error(t)})},M.prototype.fetch_tiles=function(t,e){var r=this;if(null!==this.tree){d(this.tree,t).map(function(t){r.load_subtree(t)});var n=p(this.tree,t),o=[];n.map(function(t){!1===t.loaded&&o.push(t)}),o=o.map(function(e){return[f(e.box,t),e]}),o.sort(function(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:0}),o=o.map(function(t){return t[1]}),o.map(function(t){var n=new U(r.msgbus,r.settings.texture_root_href);n.load(t.url,e),t.content=n,t.loaded=!0,t.last_touched=y()})}},M.prototype.get_relevant_tiles=function(t){return null===this.tree?[]:p(this.tree,t).map(function(t){return t.last_touched=y(),t})},M.prototype.stepMap=function(t){var e=t.getScaleDenominator();if(null===this.tree)return[0,e];var r=1-Math.pow(this.tree.metadata.start_scale_Sb/e,2),n=(this.tree.metadata.no_of_steps_Ns+1)*r;return[Math.max(0,n),e]};var S=function(t){return 0==(t&t-1)},U=function(t,e){this.msgbus=t,this.texture_root_href=e,this.buffer=null,this.texture=null,this.textureCoordBuffer=null,this.line_triangleVertexPosBufr=null,this.displacementBuffer=null,this.polygon_triangleVertexPosBufr=null};U.prototype.load=function(t,e){1==t.endsWith("obj")?this.load_ssc_tile(t,e):1==t.endsWith("json")?this.load_image_tile(t,e):console.error("unknown url type: "+t)},U.prototype.load_ssc_tile=function(t,e){var r=this;fetch(t).then(function(t){return t.text()}).then(function(t){var n=r._obtain_data_from_text(t,e,r.class_color_dt);r.line_triangleVertexPosBufr=n[0],r.displacementBuffer=n[1],r.polygon_triangleVertexPosBufr=n[2],r.msgbus.publish("data.tile.loaded","tile.ready")}).catch(function(t){console.error(t)})},U.prototype._obtain_data_from_text=function(t,e){var r=g(),n=[],o=this._obtain_line_and_polygon_triangleVertexPosBufr(t,e,r,n),i=new Float32Array(n.flat(1)),a=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),a.itemSize=2,a.numItems=i.length/2,[o[0],a,o[1]]},U.prototype._obtain_line_and_polygon_triangleVertexPosBufr=function(t,e,r,n){var o=this,i=[],a=[],s=[],u=[],l=[];t.split("\n").forEach(function(t){return o._parseLine(t,a,r,u,i,s,l,n)});var h=new Float32Array(l.flat(1)),c=this._obtain_triangleVertexPosBufr(e,h,4,4),f=new Float32Array(u);return[c,this._obtain_triangleVertexPosBufr(e,f,3,6)]},U.prototype._obtain_triangleVertexPosBufr=function(t,e,r,n){var o=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),o.itemSize=r,o.numItems=e.length/n,o},U.prototype._parseLine=function(t,e,r,n,o,i,a,s){function u(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]-e[n])}else for(var o=0;o<t.length;o++)r.push(t[o]-e);return r}function l(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]+e[n])}else for(var o=0;o<t.length;o++)r.push(t[o]+e);return r}function h(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]*e[n])}else for(var o=0;o<t.length;o++)r.push(t[o]*e);return r}function c(t,e){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var r=0,n=0;n<t.length;n++)r+=t[n]*e[n];return r}function f(t){return c(t,t)}function p(t){return[-t[1],t[0]]}function d(t){return[t[1],-t[0]]}var v=t.split(" ");if("v"==v[0])e.push({x:Number(v[1]),y:Number(v[2]),z:Number(v[3])});else if("g"==v[0]){var m=Number(v[1].split("_")[0]);i[0]=r[m]}else if("f"==v[0]){var g=i[0];for(b=1;b<=3;b++){var _=e[Number(v[b])-1];n.push(_.x,_.y,_.z,g.r_frac,g.g_frac,g.b_frac)}}else if("#"==v[0])v.length>1&&(o[0]=v[1]);else if("l"==v[0]){for(var w=[],b=1;b<v.length;b++)w.push(e[v[b]-1]);for(var y=[],T=0;T<w.length;T++){var x=w[T];y.push([x.x,x.y,x.z,o[0]])}for(var E=0;E<y.length-1;E++){var A=y[E],R=y[E+1],B=A.slice(0,2),C=R.slice(0,2),P=function(t,e){return u(e,t)}(B,C),F=function(t){return Math.sqrt(f(t))}(P);if(0!=F){var L=function(t,e){var r=[];if(isNaN(e)){if(t.length!=e.length)throw"Vector dimensions should be equal";for(var n=0;n<t.length;n++)r.push(t[n]/e[n])}else for(var o=0;o<t.length;o++)r.push(t[o]/e);return r}(P,F),D=l(h(L,-1),d(L)),M=l(h(L,-1),p(L)),S=l(L,d(L)),U=l(L,p(L));a.push(A,A,R,A,R,R),s.push(M,D,U,D,S,U)}}}},U.prototype.load_image_tile=function(t,e){var r=this;!function(){r.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texture);var n=e.RGBA,o=e.RGBA,i=e.UNSIGNED_BYTE,a=new Uint8Array([255,255,255,255]);e.texImage2D(e.TEXTURE_2D,0,n,1,1,0,o,i,a),r.textureCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r.textureCoordBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,0,0,1,1,1,0]),e.STATIC_DRAW),fetch(t).then(function(t){return t.json()}).then(function(t){r._process_image_tile(t,e)}).catch(function(t){console.error(t)})}()},U.prototype._process_image_tile=function(t,e){var r=this,n=[];t.points.forEach(function(t){return n.push.apply(n,t)}),this._upload_image_tile_mesh(e,new Float32Array(n)),fetch(this.texture_root_href+t.texture_href,{mode:"cors"}).then(function(t){if(!t.ok)throw t;return t.blob()}).then(function(t){return createImageBitmap(t)}).then(function(t){r.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),S(t.width)&&S(t.height)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),r.msgbus.publish("data.tile.loaded","tile.loaded.texture")}).catch(function(t){console.error(t)})},U.prototype._upload_image_tile_mesh=function(t,e){this.buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),this.buffer.numItems=e.length/3},U.prototype.destroy=function(t){[this.buffer,this.textureCoordBuffer,this.line_triangleVertexPosBufr,this.displacementBuffer,this.polygon_triangleVertexPosBufr].forEach(function(e){null!==e&&(t.deleteBuffer(e),e=null)}),[this.texture].forEach(function(e){t.deleteTexture(e),e=null})};var I=function(t,e){this.ssctree=t,this.gl=e};I.prototype.evict=function(t){var e=this.gl,r=[];if(null!==this.ssctree.tree){var n=v(this.ssctree.tree).filter(function(t){return t.loaded});console.log("number of loaded tiles: "+n.length),n.forEach(function(e){null!==e.last_touched&&e.last_touched+3e3<y()&&!m(t,e.box)&&r.push(e)}),console.log("number of tiles for which memory will be released: "+r.length),r.forEach(function(t){t.content.destroy(e),t.content=null,t.last_touched=null,t.loaded=!1}),r.length>0&&e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}};for(var q=[],V=0;V<256;++V)q[V]=(V+256).toString(16).substr(1);var z=function(){this._topics={}};z.prototype.publish=function(t,e,r){null===r&&(r=0);var n=this._topics[t];return!!n&&(n.forEach(function(n){setTimeout(n(t,e,r),0)}),!0)},z.prototype.subscribe=function(t,e){var r=this;return this._topics[t]||(this._topics[t]=[]),this._topics[t].push(e),{remove:function(){var n=r._topics[t].indexOf(e);r._topics[t].splice(n,1),0===r._topics[t].length&&delete r._topics[t]}}};var O=new z;Object.freeze(O);var N=function(){this.id=b()};N.prototype.publish=function(t,e){return O.publish(t,e,this.id)},N.prototype.subscribe=function(t,e){return O.subscribe(t,e)};var Y=function(t){var i=this,a=t.canvas_nm;if(this._container="string"==typeof a?window.document.getElementById(a):a,!this._container)throw new Error("Container '"+a+"' not found.");this._abort=null,this._transform=new B(this.getCanvasContainer().getBoundingClientRect(),t.initialization.center2d,t.initialization.scale_den),this._interaction_settings={zoom_factor:1,zoom_duration:1e3,pan_duration:1e3},this.msgbus=new N,this.msgbus.subscribe("data.tile.loaded",function(t,e,r){null===i._abort&&i.panAnimated(0,0)}),this.msgbus.subscribe("data.tree.loaded",function(t,e,r){var n=i.ssctree.stepMap(i._transform);i._prepare_active_tiles(n[0])}),this.msgbus.subscribe("settings.render.boundary-width",function(t,e,r){i.renderer.settings.boundary_width=parseFloat(e),i.abortAndRender()}),this.msgbus.subscribe("settings.interaction.zoom-factor",function(t,e,r){i._interaction_settings.zoom_factor=parseFloat(e),i.abortAndRender()}),this.msgbus.subscribe("settings.interaction.zoom-animation",function(t,e,r){i._interaction_settings.zoom_duration=parseFloat(e),i.abortAndRender()}),this.msgbus.subscribe("settings.interaction.pan-animation",function(t,e,r){i._interaction_settings.pan_duration=parseFloat(e),i.abortAndRender()}),this.ssctree=new M(this.msgbus,t.datasets[0]),this.renderer=new D(this._container.getContext("webgl",{alpha:!0,antialias:!0}),this.ssctree),this.renderer.setViewport(this.getCanvasContainer().width,this.getCanvasContainer().height),e(this),r(this),n(this),o(this);var s=this.ssctree.stepMap(this.getTransform());this.msgbus.publish("map.scale",[this.getTransform().getCenter(),s[1]]),this.evictor=new I(this.ssctree,this.getCanvasContainer().getContext("webgl",{alpha:!0,antialias:!0})),window.setInterval(function(){var t=i.ssctree.stepMap(i.getTransform()),e=t[0],r=i.getTransform().getVisibleWorld(),n=[r.xmin,r.ymin,e,r.xmax,r.ymax,e];i.evictor.evict(n),i.render()},3e4)};return Y.prototype.loadTree=function(){this.ssctree.load()},Y.prototype.getCanvasContainer=function(){return this._container},Y.prototype.getTransform=function(){return this._transform},Y.prototype.render=function(){var t=this.ssctree.stepMap(this.getTransform()),e=this._prepare_active_tiles(t[0]);this.msgbus.publish("map.scale",[this.getTransform().getCenter(),t[1]]),this.renderer.render_relevant_tiles(e[0],e[1],t)},Y.prototype._prepare_active_tiles=function(t){var e=this.getTransform().world_square;e[10]=-2/(t- -.5),e[14]=(t+-.5)/(t- -.5);var r=this.getTransform().getVisibleWorld(),n=[r.xmin,r.ymin,t,r.xmax,r.ymax,t],o=this._container.getContext("webgl",{alpha:!0,antialias:!0});return this.ssctree.fetch_tiles(n,o),[e,n]},Y.prototype.doEaseNone=function(t,e){var r=this;return function(n){for(var o=new Float32Array(16),i=0;i<16;i++){var a=t[i]+n*(e[i]-t[i]);o[i]=a}r.getTransform().world_square=o,r.getTransform().updateViewportTransform(),r.render(),1==n&&(r._abort=null)}},Y.prototype.doEaseInOutSine=function(t,e){function r(r){for(var n=new Float32Array(16),o=Math.cos(Math.PI*r)-1,i=0;i<16;i++){var a=e[i]-t[i],s=.5*-a*o+t[i];n[i]=s}this.getTransform().world_square=n,this.getTransform().updateViewportTransform(),this.render(),1==r&&(this._abort=null)}return r},Y.prototype.doEaseOutSine=function(t,e){var r=this;return function(n){for(var o=new Float32Array(16),i=Math.sin(n*(.5*Math.PI)),a=0;a<16;a++){var s=e[a]-t[a],u=s*i+t[a];o[a]=u}r.getTransform().world_square=o,r.getTransform().updateViewportTransform(),r.render(),1===n&&(r._abort=null)}},Y.prototype.doEaseOutQuint=function(t,e){function r(r){for(var n=r-1,o=Math.pow(n,5)+1,i=new Float32Array(16),a=0;a<16;a++){var s=e[a]-t[a],u=s*o+t[a];i[a]=u}this.getTransform().world_square=i,this.getTransform().updateViewportTransform(),this.render(),1==r&&(this._abort=null)}return r},Y.prototype.animateZoom=function(t,e,r){var n=this.getTransform().world_square;this.getTransform().zoom(r,t,this.getCanvasContainer().getBoundingClientRect().height-e);var o=this.getTransform().world_square;return this.doEaseOutSine(n,o)},Y.prototype.animatePan=function(t,e){var r=this.getTransform().world_square;this.getTransform().pan(t,-e);var n=this.getTransform().world_square;return this.doEaseOutSine(r,n)},Y.prototype.jumpTo=function(t,e,r){var n=[t,e],o=this.getCanvasContainer(),i=[o.width,o.height],a=r;this._transform.initTransform(n,i,a),this.abortAndRender()},Y.prototype.panBy=function(t,e){null!==this._abort&&this._abort(),this.getTransform().pan(t,-e),this.render()},Y.prototype.zoom=function(t,e,r){this.getTransform().zoom(r,t,this.getCanvasContainer().getBoundingClientRect().height-e),this.render()},Y.prototype.abortAndRender=function(){null!==this._abort&&(this._abort(),this._abort=null),this.getTransform().pan(0,0),this.render()},Y.prototype.zoomInAnimated=function(t,e,r){this.zoomAnimated(t,e,1+r)},Y.prototype.zoomOutAnimated=function(t,e,r){this.zoomAnimated(t,e,1/(1+r))},Y.prototype.zoomAnimated=function(e,r,n){null!==this._abort&&this._abort();var o=this.animateZoom(e,r,n);this._abort=t(o,this._interaction_settings.zoom_duration,this)},Y.prototype.panAnimated=function(e,r){null!==this._abort&&this._abort();var n=this.animatePan(e,r);this._abort=t(n,this._interaction_settings.pan_duration,this)},Y.prototype.resize=function(t,e){var r=this.getTransform(),n=r.getCenter(),o=r.getScaleDenominator();r.initTransform(n,[t,e],o),
this.renderer.setViewport(t,e)},{Map:Y,MessageBusConnector:N}}();
//# sourceMappingURL=index.js.map
