!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).varioscale=e()}(this,(function(){"use strict";var t=window.performance&&window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date),e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,r=function(t){return e(t)};function n(e,n,o){if(!n)return e.call(o,1),null;var i=!1,a=t(),s=1e3*n;return r((function n(u){if(!i)if((u=t())>=a+s)e.call(o,1);else{var l=(u-a)/s;e.call(o,l),r(n)}})),function(){i=!0}}var o=function(t){this._trace=[],this.push(t)};function i(){for(var t=document.getElementsByName("speed"),e=1,r=0,n=t.length;r<n;r++)if(t[r].checked){e=parseFloat(t[r].value);break}return e}function a(){var t=new Float64Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function s(t,e){var r=e[0],n=e[1],o=e[2],i=e[3],a=e[4],s=e[5],u=e[6],l=e[7],h=e[8],c=e[9],f=e[10],p=e[11],d=e[12],g=e[13],_=e[14],m=e[15],v=r*s-n*a,E=r*u-o*a,b=r*l-i*a,T=n*u-o*s,y=n*l-i*s,w=o*l-i*u,R=h*g-c*d,x=h*_-f*d,A=h*m-p*d,F=c*_-f*g,S=c*m-p*g,C=f*m-p*_,L=v*C-E*S+b*F+T*A-y*x+w*R;return L?(L=1/L,t[0]=(s*C-u*S+l*F)*L,t[1]=(o*S-n*C-i*F)*L,t[2]=(g*w-_*y+m*T)*L,t[3]=(f*y-c*w-p*T)*L,t[4]=(u*A-a*C-l*x)*L,t[5]=(r*C-o*A+i*x)*L,t[6]=(_*b-d*w-m*E)*L,t[7]=(h*w-f*b+p*E)*L,t[8]=(a*S-s*A+l*R)*L,t[9]=(n*A-r*S-i*R)*L,t[10]=(d*y-g*b+m*v)*L,t[11]=(c*b-h*y-p*v)*L,t[12]=(s*x-a*F-u*R)*L,t[13]=(r*F-n*x+o*R)*L,t[14]=(g*E-d*T-_*v)*L,t[15]=(h*T-c*E+f*v)*L,t):null}o.prototype.shift=function(e){for(var r=t();this._trace.length>0&&r-this._trace[0][0]>e;)this._trace.shift()},o.prototype.push=function(e){var r=t();this._trace.push([r,e])},o.prototype.first=function(){return this._trace[0]},o.prototype.last=function(){return this._trace[this._trace.length-1]},o.prototype.lastbutone=function(){return this._trace[this._trace.length-2]},o.prototype.length=function(){return this._trace.length};var u=function(t,e,r){var n=e[0],o=e[1],i=e[2],a=e[3],s=e[4],u=e[5],l=e[6],h=e[7],c=e[8],f=e[9],p=e[10],d=e[11],g=e[12],_=e[13],m=e[14],v=e[15],E=r[0],b=r[1],T=r[2],y=r[3];return t[0]=E*n+b*s+T*c+y*g,t[1]=E*o+b*u+T*f+y*_,t[2]=E*i+b*l+T*p+y*m,t[3]=E*a+b*h+T*d+y*v,E=r[4],b=r[5],T=r[6],y=r[7],t[4]=E*n+b*s+T*c+y*g,t[5]=E*o+b*u+T*f+y*_,t[6]=E*i+b*l+T*p+y*m,t[7]=E*a+b*h+T*d+y*v,E=r[8],b=r[9],T=r[10],y=r[11],t[8]=E*n+b*s+T*c+y*g,t[9]=E*o+b*u+T*f+y*_,t[10]=E*i+b*l+T*p+y*m,t[11]=E*a+b*h+T*d+y*v,E=r[12],b=r[13],T=r[14],y=r[15],t[12]=E*n+b*s+T*c+y*g,t[13]=E*o+b*u+T*f+y*_,t[14]=E*i+b*l+T*p+y*m,t[15]=E*a+b*h+T*d+y*v,t},l=function(t,e,r,n){this.xmin=t,this.ymin=e,this.xmax=r,this.ymax=n};l.prototype.width=function(){return this.xmax-this.xmin},l.prototype.height=function(){return this.ymax-this.ymin},l.prototype.toString=function(){return"new Rectangle("+this.xmin+", "+this.ymin+", "+this.xmax+", "+this.ymax+")"},l.prototype.area=function(){return this.width()*this.height()},l.prototype.center=function(){return[this.xmin+.5*this.width(),this.ymin+.5*this.height()]};var h=3779.5275590551;var c=function(t,e,r){this.viewport_world=a(),this.world_viewport=a(),this.world_square=null,this.square_viewport=null,this.viewport=null,this.initTransform(t,e,r),this.snapped_step=Number.MAX_SAFE_INTEGER,this.snapped_St=r};c.prototype.initTransform=function(t,e,r){var n=t[0],o=t[1],i=[.5*e[0]/h*r,.5*e[1]/h*r],a=n-i[0],s=n+i[0],u=o-i[1],c=o+i[1];this.viewport=new l(0,0,e[0],e[1]);var f=new l(a,u,s,c);this.update_world_square_viewport(f,n,o)},c.prototype.pan=function(t,e){this.square_viewport[12]+=t,this.square_viewport[13]+=e,u(this.world_viewport,this.square_viewport,this.world_square),s(this.viewport_world,this.world_viewport);var r=this.getVisibleWorld(),n=r.center();this.update_world_square_viewport(r,n[0],n[1])},c.prototype.compute_zoom_parameters=function(t,e,r,n,o){var i=this.getScaleDenominator(),a=t.get_step_from_St(i);this.compute_matrix_parameters(e,r,n);var s=1;if(1==o){var u=this.getScaleDenominator(),l=t.get_zoom_snappedstep_from_St(u,e);s=t.get_time_factor(u,e,a);var h=t.get_St_from_step(l);this.snapped_step=l,this.snapped_St=h,this.compute_matrix_parameters(u/h,r,n)}return s},c.prototype.compute_matrix_parameters=function(t,e,r){var n=a(),o=a();o[12]=-e,o[13]=-r,u(n,o,this.square_viewport);var i=a();i[0]=t,i[5]=t,u(n,i,n);var l=a();l[12]=e,l[13]=r,u(n,l,n),u(this.world_viewport,n,this.world_square),s(this.viewport_world,this.world_viewport);var h=this.getVisibleWorld(),c=h.center();this.update_world_square_viewport(h,c[0],c[1])},c.prototype.update_world_square_viewport=function(t,e,r){var n,o,i,s,u,l,h=[2/t.width(),2/t.height()],c=[-h[0]*e,-h[1]*r],f=a();f[0]=h[0],f[5]=h[1],f[12]=c[0],f[13]=c[1],this.world_square=f,this.square_viewport=(n=this.viewport,o=.5*(n.xmax-n.xmin),i=.5*(n.ymax-n.ymin),s=.5*(n.xmax+n.xmin),u=.5*(n.ymax+n.ymin),(l=a())[0]=o,l[5]=i,l[12]=s,l[13]=u,l),this.updateViewportTransform()},c.prototype.backward=function(t){var e,r=((e=new Float64Array(3))[0]=0,e[1]=0,e[2]=0,e);return function(t,e,r){var n=e[0],o=e[1],i=e[2],a=r[3]*n+r[7]*o+r[11]*i+r[15];a=a||1,t[0]=(r[0]*n+r[4]*o+r[8]*i+r[12])/a,t[1]=(r[1]*n+r[5]*o+r[9]*i+r[13])/a,t[2]=(r[2]*n+r[6]*o+r[10]*i+r[14])/a}(r,t,this.viewport_world),r},c.prototype.updateViewportTransform=function(){u(this.world_viewport,this.square_viewport,this.world_square),s(this.viewport_world,this.world_viewport)},c.prototype.getVisibleWorld=function(){var t=this.backward([this.viewport.xmin,this.viewport.ymin,0]),e=this.backward([this.viewport.xmax,this.viewport.ymax,0]);return new l(t[0],t[1],e[0],e[1])},c.prototype.getCenterWorld=function(){return this.backward([this.viewport.xmin+.5*(this.viewport.xmax-this.viewport.xmin),this.viewport.ymin+.5*(this.viewport.ymax-this.viewport.ymin),0])},c.prototype.getScaleDenominator=function(){var t=this.viewport.width()/h;return this.getVisibleWorld().width()/t};var f=function(t,e,r){var n=a(t,t.VERTEX_SHADER,e),o=a(t,t.FRAGMENT_SHADER,r),i=t.createProgram();function a(t,e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error("ERROR occurred while compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}t.attachShader(i,n),t.attachShader(i,o),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?(t.validateProgram(i),t.getProgramParameter(i,t.VALIDATE_STATUS)?(this.shaderProgram=i,this.gl=t):console.error("ERROR validating program!",t.getProgramInfoLog(i))):console.error("ERROR linking program!",t.getProgramInfoLog(i))};f.prototype._specify_data_for_shaderProgram=function(t,e,r,n,o,i){var a=t.getAttribLocation(e,r);t.enableVertexAttribArray(a),t.vertexAttribPointer(a,n,t.FLOAT,!1,o,i)};var p=function(t){function e(e){t.call(this,e,"\nprecision highp float;\n\nattribute vec3 vertexPosition_modelspace;\nattribute vec2 aTextureCoord;\n\nuniform mat4 M;\n\nvarying highp vec2 vTextureCoord;\n\n\nvoid main()\n{\n    gl_Position = M * vec4(vertexPosition_modelspace, 1.0);\n    vTextureCoord = aTextureCoord;\n}\n","\nprecision highp float;\n\nvarying highp vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float opacity;\n            \nvoid main()\n{\n    vec4 color = texture2D(uSampler, vTextureCoord);\n    color.a = opacity;\n    gl_FragColor = color;\n}\n")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e,r){if(null!==e.content.buffer){var n=this.gl,o=this.shaderProgram;n.useProgram(o),n.bindBuffer(n.ARRAY_BUFFER,e.content.buffer);var i=n.getAttribLocation(o,"vertexPosition_modelspace");n.vertexAttribPointer(i,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(i);var a=n.getUniformLocation(o,"M");n.uniformMatrix4fv(a,!1,t);var s=n.getUniformLocation(o,"opacity");n.uniform1f(s,r.opacity),n.bindBuffer(n.ARRAY_BUFFER,e.content.textureCoordBuffer),this._specify_data_for_shaderProgram(n,o,"aTextureCoord",2,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,e.content.texture);var u=n.getUniformLocation(o,"uSampler");n.uniform1i(u,0),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.enable(n.DEPTH_TEST),n.drawArrays(n.TRIANGLES,0,e.content.buffer.numItems)}},e}(f),d=function(t){function e(e){t.call(this,e,"precision highp float;\nattribute vec4 a_Position;\nattribute vec2 a_TexCoord;\nvarying vec2 v_TexCoord;\nvoid main() {\n  gl_Position = a_Position;\n  v_TexCoord = a_TexCoord;\n}\n","\n            precision highp float;       \n            uniform sampler2D uSampler;\n            uniform float opacity;\n            varying vec2 v_TexCoord;\n            void main() {\n              vec4 color = texture2D(uSampler, v_TexCoord);\n              if (color.a == 0.0) //when clearing the buffer of fbo, we used value 0.0 for opacity; see render.js\n                { discard; } \n              else \n                { color.a = opacity; } \n              gl_FragColor = color;\n            }")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_fbo=function(t,e){if(null!==t){var r=this.gl,n=this.shaderProgram;r.useProgram(n),r.program=n;var o=function(t){var e=new Float32Array([-1,1,0,1,-1,-1,0,0,1,1,1,1,1,-1,1,0]),r=4,n=t.createBuffer();if(!n)return console.log("Failed to create the buffer object"),-1;t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);var o=e.BYTES_PER_ELEMENT,i=t.getAttribLocation(t.program,"a_Position");if(i<0)return console.log("Failed to get the storage location of a_Position"),-1;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*o,0),t.enableVertexAttribArray(i);var a=t.getAttribLocation(t.program,"a_TexCoord");if(a<0)return console.log("Failed to get the storage location of a_TexCoord"),-1;return t.vertexAttribPointer(a,2,t.FLOAT,!1,4*o,2*o),t.enableVertexAttribArray(a),r}(r);if(o<0)console.log("Failed to set the vertex information");else{var i=r.getUniformLocation(n,"opacity");r.uniform1f(i,e),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.texture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);var a=r.getUniformLocation(n,"uSampler");r.uniform1i(a,0),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.disable(r.DEPTH_TEST),r.drawArrays(r.TRIANGLE_STRIP,0,o),r.bindTexture(r.TEXTURE_2D,null)}}else console.log("drawprograms.js fbo is null:",t)},e}(f),g=function(t){function e(e){t.call(this,e,"\nprecision highp float;\n\nattribute vec2 displacement;\nattribute vec4 vertexPosition_modelspace;\nuniform mat4 M;\nuniform float near;\nuniform float half_width_reality;\n\nvoid main()\n{\n    vec4 pos = vertexPosition_modelspace;\n\n    if (pos.z <= near && pos.w > near)\n    {\n        pos.x +=  displacement.x * half_width_reality;\n        pos.y +=  displacement.y * half_width_reality;\n        gl_Position = M * vec4(pos.xyz, 1.0);\n\n    } else {\n        gl_Position = vec4(-10.0,-10.0,-10.0,1.0);\n        return;\n    }\n}\n","\nprecision highp float;\nuniform vec4 uColor;\n\nvoid main()\n{\n    gl_FragColor = uColor; // color of the lines\n}\n"),this.colors=[[141,211,199],[190,186,218],[251,128,114],[128,177,211],[253,180,98],[179,222,105],[252,205,229],[217,217,217],[188,128,189],[204,235,197]].map((function(t){return[t[0]/255,t[1]/255,t[2]/255]}))}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e,r,n,o){var i=this.gl,a=this.shaderProgram,s=e.content.line_triangleVertexPosBufr,u=e.content.displacementBuffer;if(null!==s){i.useProgram(a),i.bindBuffer(i.ARRAY_BUFFER,s),this._specify_data_for_shaderProgram(i,a,"vertexPosition_modelspace",4,0,0),i.bindBuffer(i.ARRAY_BUFFER,u),this._specify_data_for_shaderProgram(i,a,"displacement",2,0,0);var l=n.boundary_width*r[1]/1e3/2,h=i.getUniformLocation(a,"M");i.uniformMatrix4fv(h,!1,t);var c=i.getUniformLocation(a,"near");i.uniform1f(c,r[0]);var f=i.getUniformLocation(a,"half_width_reality");i.uniform1f(f,l);var p=[0,0,0],d=i.getUniformLocation(a,"uColor");i.uniform4f(d,p[0],p[1],p[2],o.opacity),i.disable(i.CULL_FACE),i.disable(i.DEPTH_TEST),1==o.do_blend?i.enable(i.BLEND):i.disable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.drawArrays(i.TRIANGLES,0,s.numItems)}},e}(f),_=function(t){function e(e){t.call(this,e,"\nprecision highp float;\n\nattribute vec3 vertexPosition_modelspace;\nattribute vec3 vertexColor;\nuniform mat4 M;\nvarying vec4 fragColor;\nuniform float opacity;\n\nvoid main()\n{\n    fragColor = vec4(vertexColor, opacity);\n    gl_Position = M * vec4(vertexPosition_modelspace, 1);\n}\n","\nprecision highp float;\n\nvarying vec4 fragColor;\nvoid main()\n{\n    gl_FragColor = vec4(fragColor);\n}\n")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.draw_tile=function(t,e,r,n,o){var i=e.content.polygon_triangleVertexPosBufr;if(null!==i){var a=this.gl,s=this.shaderProgram;a.useProgram(s),a.bindBuffer(a.ARRAY_BUFFER,i),this._specify_data_for_shaderProgram(a,s,"vertexPosition_modelspace",3,24,0),this._specify_data_for_shaderProgram(a,s,"vertexColor",3,24,12);var u=a.getUniformLocation(s,"M");a.uniformMatrix4fv(u,!1,t);var l=a.getUniformLocation(s,"opacity");a.uniform1f(l,r.opacity),a.enable(a.CULL_FACE),1==r.draw_cw_faces?a.cullFace(a.BACK):a.cullFace(a.FRONT),1==r.do_depth_test?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),0==r.do_blend||1==r.opacity?a.disable(a.BLEND):a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.drawArrays(a.TRIANGLES,0,i.numItems)}},e.prototype.draw_tile_into_fbo=function(t,e,r,n,o){var i=e.content.polygon_triangleVertexPosBufr;if(null===i)return 0;var a=this.gl,s=this.shaderProgram;a.useProgram(s),a.bindFramebuffer(a.FRAMEBUFFER,a.fbo),a.viewport(0,0,n,o);var u=new Uint8Array(4);a.readPixels(n/2,o/2,1,1,a.RGBA,a.UNSIGNED_BYTE,u),a.bindBuffer(a.ARRAY_BUFFER,i),this._specify_data_for_shaderProgram(a,s,"vertexPosition_modelspace",3,24,0),this._specify_data_for_shaderProgram(a,s,"vertexColor",3,24,12);var l=a.getUniformLocation(s,"M");a.uniformMatrix4fv(l,!1,t);var h=a.getUniformLocation(s,"opacity");a.uniform1f(h,1),a.disable(a.CULL_FACE),1==r.draw_cw_faces?a.cullFace(a.BACK):a.cullFace(a.FRONT),1==r.do_depth_test?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),1==r.do_blend?a.enable(a.BLEND):a.disable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.drawArrays(a.TRIANGLES,0,i.numItems),a.bindFramebuffer(a.FRAMEBUFFER,null)},e}(f);var m=function(){this._topics={}};m.prototype.publish=function(t,e,r){null===r&&(r=0);var n=this._topics[t];return!!n&&(n.forEach((function(n){setTimeout(n(t,e,r),0)})),!0)},m.prototype.subscribe=function(t,e){var r=this;return this._topics[t]||(this._topics[t]=[]),this._topics[t].push(e),{remove:function(){var n=r._topics[t].indexOf(e);r._topics[t].splice(n,1),0===r._topics[t].length&&delete r._topics[t]}}};var v=new m;Object.freeze(v);var E=function(){this.id=Math.round(1e18*Math.random()).toString(36).substring(0,10)};E.prototype.publish=function(t,e){return v.publish(t,e,this.id)},E.prototype.subscribe=function(t,e){return v.subscribe(t,e)};var b=function(t,e,r){this.gl=t,this.ssctrees=r,this.settings={boundary_width:.2},this.programs=[new _(t),new g(t),new p(t)],this.canvas=e,this.setViewport(e.width,e.height)};function T(t){return(Math.exp(t)-Math.exp(-t))/2}function y(t){return(Math.exp(t)+Math.exp(-t))/2}function w(t,e){for(var r=[],n=0;n<t.length;n+=1)r.push(t[n]-e[n]);return r}function R(e,r,n,o,i,a){console.log(e),console.log(r),console.log(n),console.log(o),console.log(i),console.log(a);var s=w(o,e);console.log("travel vec := "+s+" ");var u,l,h,c,f=Math.max(n[0],n[1]),p=f*i/r,d=(u=e,h=(l=o)[0]-u[0],c=l[1]-u[1],Math.sqrt(h*h+c*c)||1),g=1.2,_=1.44;function m(t){var e=(p*p-f*f+(t?-1:1)*_*_*d*d)/(2*(t?p:f)*_*d),r=Math.sqrt(e*e+1)-e;return r<1e-9?-18:Math.log(r)}var v=m(0);function E(t){return f*(y(v)*(T(e=v+g*t)/y(e))-T(v))/_;var e}var b=(m(1)-v)/g,R=t(),x=1e3*a;return function(n){var a=(t()-R)/x,s=function(t){return 1-Math.pow(1-t,1.5)}(a)*b;return a<1?[function(t,e){for(var r=[],n=0;n<t.length;n+=1)r.push(t[n]+e[n]);return r}(e,function(t,e){for(var r=[],n=0;n<t.length;n+=1)r.push(t[n]*e);return r}(w(o,e),E(s)/d)),function(t){return f*(y(v)/y(v+g*t))}(s)/f*r]:[o,i]}}b.prototype.render_ssctrees=function(t,e,r,n,o){var i=this;this._clearColor();for(var a=function(a){var s=i.ssctrees[a],u=s.tree_setting,l=u.low_scale,h=u.high_scale;if(!(null!=l&&l>r||null!=h&&h<r||null==s.tree||0==u.do_draw||u.opacity<=0)){var c=u.state_compensation,f=t[a]-c,p=Number.MAX_SAFE_INTEGER;null!=s.tree&&(p=s.tree.metadata.no_of_steps_Ns),f<0?f=0:f>=p&&(f=p-1e-6);var d=u.opacity,g=d,_=0,m=0;if(1==u.do_color_adapt)if(n[a]==o[a]);else g=(d-(_=(f-n[a])/(o[a]-n[a])*d))/(1-_),m=o[a]-c;var v=e.getVisibleWorld(),E=[v.xmin,v.ymin,f,v.xmax,v.ymax,f],b=s.get_relevant_tiles(E,i.gl),T=s.prepare_matrix(f,e);if(i.render_relevant_tiles(s,b,T,g),1==u.do_color_adapt&&_>0){var y=s.prepare_matrix(m,e);i.render_relevant_tiles(s,b,y,_)}if(i.settings.boundary_width>0&&"polygon"==u.datatype){var w=i.programs[1];b.forEach((function(t){w.draw_tile(T,t,[f,r],i.settings,u)}))}}},s=t.length-1;s>=0;s--)a(s)},b.prototype.render_relevant_tiles=function(t,e,r,n){this._clearDepth(),this._clearDepthFbo(),this._clearColorFbo();var o=this.gl,i=t.tree_setting,a=this.canvas;if(e.length>0&&n>0)if("polygon"==i.datatype){var s=this.programs[0];if(1==n)e.forEach((function(t){s.draw_tile(r,t,i,a.width,a.height)}));else e.forEach((function(t){s.draw_tile_into_fbo(r,t,i,a.width,a.height)})),new d(o).draw_fbo(o.fbo,n)}else if("image"==i.datatype){var u=this.programs[2];e.filter((function(t){return null!==t.texture})).forEach((function(t){u.draw_tile(r,t,i)}))}},b.prototype._clearDepth=function(){var t=this.gl;t.clearDepth(1),t.clear(t.DEPTH_BUFFER_BIT)},b.prototype._clearDepthFbo=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,t.fbo),t.clearDepth(1),t.clear(t.DEPTH_BUFFER_BIT),t.bindFramebuffer(t.FRAMEBUFFER,null)},b.prototype._clearColor=function(t,e,r,n){void 0===t&&(t=1),void 0===e&&(e=1),void 0===r&&(r=1),void 0===n&&(n=0);var o=this.gl;o.clearColor(t,r,e,n),o.clear(o.COLOR_BUFFER_BIT)},b.prototype._clearColorFbo=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,t.fbo),this._clearColor(1,1,1,0),t.bindFramebuffer(t.FRAMEBUFFER,null)},b.prototype.setViewport=function(t,e){this.gl.viewport(0,0,t,e)};var x=function(t,e,r){if(e<0||r<0||e>t.matrixSize[0]||r>t.matrixSize[1])throw new Error("tile outside bounds of tileMatrix");this.tileMatrix=t,this.col=e,this.row=r};x.prototype.bounds=function(){var t=this.col,e=this.row;return[this.tileMatrix.topLeftCorner[0]+t*this.tileMatrix.tileSpan[0],this.tileMatrix.topLeftCorner[1]+-(e+1)*this.tileMatrix.tileSpan[1],this.tileMatrix.topLeftCorner[0]+(t+1)*this.tileMatrix.tileSpan[0],this.tileMatrix.topLeftCorner[1]+-e*this.tileMatrix.tileSpan[1]]},x.prototype.getRequestUrl=function(){var t="https://geodata.nationaalgeoregister.nl/tiles/service/wmts?";return t+="service=WMTS&request=GetTile&version=1.0.0&format=image/png8",t+="&tileMatrixSet="+this.tileMatrix.tileMatrixSet,t+="&layer="+this.tileMatrix.layer,t+="&style="+this.tileMatrix.style,t+="&tileMatrix="+this.tileMatrix.level,t+="&TileCol="+this.col,t+="&TileRow="+this.row},x.prototype.getId=function(){return this.tileMatrix.layer+"-"+this.tileMatrix.level+"-"+this.col+"-"+this.row};var A=function(t,e){this.scaleDenominator=e,this.layer="opentopo",this.style="default",this.tileMatrixSet="EPSG:28992",this.identifier=t,this.level=t;var r=Math.pow(2,t);this.matrixSize=[r,r],this.topLeftCorner=[-285401.92,903401.92],this.tileSize=[256,256];var n=28e-5*e;this.tileSpan=this.tileSize.map((function(t){return t*n}))};A.prototype.bounds=function(){return[this.topLeftCorner[0],this.topLeftCorner[1]-this.tileSpan[1]*this.matrixSize[1],this.topLeftCorner[0]+this.tileSpan[0]*this.matrixSize[0],this.topLeftCorner[1]]},A.prototype.overlappingTiles=function(t){var e=t[0],r=t[1],n=t[2],o=t[3];e=Math.max(e,this.topLeftCorner[0]),r=Math.max(r,this.topLeftCorner[1]-this.tileSpan[1]*this.matrixSize[1]),n=Math.min(n,this.topLeftCorner[0]+this.tileSpan[0]*this.matrixSize[0]),o=Math.min(o,this.topLeftCorner[1]);for(var i=[this.topLeftCorner[0],this.topLeftCorner[1]-this.tileSpan[1]*this.matrixSize[1]],a=Math.ceil((n-e)/this.tileSpan[0]),s=Math.ceil((o-r)/this.tileSpan[1]),u=Math.floor((e-i[0])/this.tileSpan[0]),l=Math.floor((r-i[1])/this.tileSpan[1]),h=[],c=u;c<Math.min(u+a+1,this.matrixSize[0]);c++)for(var f=l;f<=Math.min(l+s+1,this.matrixSize[1]);f++){var p=c,d=this.matrixSize[1]-1-f;p>=0&&p<this.matrixSize[0]&&d>=0&&d<this.matrixSize[1]&&h.push(this.getTile(p,d))}return h},A.prototype.getTile=function(t,e){return new x(this,t,e)};var F=function(){this.tileMatrixSet=[];for(var t=12288e3,e=0;e<14;e++)this.tileMatrixSet.push(new A(e,t)),t/=2};F.prototype.tilesInView=function(t,e){return this.snapToScale(e).overlappingTiles(t)},F.prototype.snapToScale=function(t){for(var e=0,r=this.tileMatrixSet;e<r.length;e+=1){var n=r[e],o=.5*n.scaleDenominator;if(t>=n.scaleDenominator-.5*o)break}return n};var S=function(t){return 0==(t&t-1)},C=function(t){this.gl=t,this.vertexCoordBuffer=null,this.texture=null,this.textureCoordBuffer=null};C.prototype.uploadPoints=function(t){var e=this.gl,r=t[0],n=t[1],o=t[2],i=t[3],a=[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random()),0],s=a[0],u=a[1],l=a[2];this.vertexCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexCoordBuffer);var h=new Float32Array([r,i,0,s,u,l,r,n,0,s,u,l,o,n,0,s,u,l,r,i,0,s,u,l,o,n,0,s,u,l,o,i,0,s,u,l]);e.bufferData(e.ARRAY_BUFFER,h,e.STATIC_DRAW)},C.prototype.initTexture=function(){var t=this.gl;this.textureCoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.textureCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,0,0,1,1,1,0]),t.STATIC_DRAW)},C.prototype.uploadTexture=function(t){var e=this.gl;this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),S(t.width)&&S(t.height)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR))},C.prototype.destroy=function(){var t=this.gl;[this.vertexCoordBuffer,this.textureCoordBuffer].forEach((function(e){null!==e&&(t.deleteBuffer(e),e=null)})),[this.texture].forEach((function(e){null!==e&&(t.deleteTexture(e),e=null)}))};var L=function(t,e,r){var n=a(t,t.VERTEX_SHADER,e),o=a(t,t.FRAGMENT_SHADER,r),i=t.createProgram();function a(t,e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.error("ERROR occurred while compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}t.attachShader(i,n),t.attachShader(i,o),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?(t.validateProgram(i),t.getProgramParameter(i,t.VALIDATE_STATUS)?(this.shaderProgram=i,this.gl=t,console.error(this.shaderProgram)):console.error("ERROR validating program!",t.getProgramInfoLog(i))):console.error("ERROR linking program!",t.getProgramInfoLog(i))};function B(t){var e=t[0],r=t[1];return[e+.5*(t[2]-e),r+.5*(t[3]-r)]}L.prototype._specifyDataForShaderProgram=function(t,e,r,n,o,i){var a=t.getAttribLocation(e,r);t.enableVertexAttribArray(a),t.vertexAttribPointer(a,n,t.FLOAT,!1,o,i)},L.prototype.clearColor=function(){var t=this.gl;t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)},L.prototype.drawTile=function(t,e){var r=e.vertexCoordBuffer;if(null!==r&&null!==e.texture){var n=this.gl,o=this.shaderProgram;n.useProgram(o),n.bindBuffer(n.ARRAY_BUFFER,r),this._specifyDataForShaderProgram(n,o,"vertexPosition_modelspace",3,24,0);var i=n.getUniformLocation(o,"M");n.uniformMatrix4fv(i,!1,t);var a=n.getUniformLocation(o,"opacity");n.uniform1f(a,1),n.bindBuffer(n.ARRAY_BUFFER,e.textureCoordBuffer),this._specifyDataForShaderProgram(n,o,"aTextureCoord",2,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,e.texture);var s=n.getUniformLocation(o,"uSampler");n.uniform1i(s,0),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.drawArrays(n.TRIANGLES,0,6)}};var P=function(t,e){this.layer=new F,this.gl=t,this.msgBus=e,this.program=new L(this.gl,"\nprecision highp float;\n\nattribute vec3 vertexPosition_modelspace;\nattribute vec2 aTextureCoord;\n\nuniform mat4 M;\n\nvarying highp vec2 vTextureCoord;\n\nvoid main()\n{\n    gl_Position = M * vec4(vertexPosition_modelspace, 1.0);\n    vTextureCoord = aTextureCoord;\n}\n","\nprecision highp float;\n\nvarying highp vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float opacity;\n            \nvoid main()\n{\n    vec4 color = texture2D(uSampler, vTextureCoord);\n    color.a = opacity;\n    gl_FragColor = color;\n}\n"),this.activeTiles=new Map,this.activeDownloads=new Map};P.prototype.sortRadially=function(t,e){return(t=t.map((function(t){return[(r=t.bounds(),n=e,o=B(r),i=B(n),Math.pow(i[0]-o[0],2)+Math.pow(i[1]-o[1],2)),t];var r,n,o,i}))).sort((function(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:0})),t=t.map((function(t){return t[1]}))},P.prototype.update=function(t,e,r){var n=this,o=this.layer.tilesInView(t,e);o=this.sortRadially(o,t);var i=this.layer.tilesInView(t,2*e);i=this.sortRadially(i,t);var a=this.layer.tilesInView(t,4*e);a=this.sortRadially(a,t);var s=i.concat(o),u=[];s.forEach((function(t){var e=t.getId();if(n.activeTiles.has(e))u.push(n.activeTiles.get(e));else{var r=new C(n.gl);r.uploadPoints(t.bounds()),r.initTexture();var o=new AbortController,i=o.signal;n.activeTiles.set(e,r),n.activeDownloads.set(e,o),fetch(t.getRequestUrl(),{mode:"cors",signal:i}).then((function(t){t.ok||(console.warn(t),n.activeTiles.get(e).destroy(),n.activeTiles.delete(e));return t.blob()})).then((function(t){return createImageBitmap(t)})).then((function(t){r.uploadTexture(t),n.activeDownloads.delete(e),n.msgBus.publish("data.tile.loaded","tile.loaded.texture")})).catch((function(t){n.activeDownloads.delete(e)}))}}));var l=new Set;s.map((function(t){var e=t.getId();l.add(e)})),console.log("cancelling as activeDownloads size has grown to "+this.activeDownloads.size+" > "+2*l.size);for(var h=this.activeDownloads.entries(),c=function(t){var e=h.next().value,r=e[0],o=e[1];l.has(r)||setTimeout((function(){o.abort(),n.activeTiles.get(r).destroy(),n.activeTiles.delete(r)}))},f=0;f<n.activeDownloads.size;f++)c();this.program.clearColor(),u.forEach((function(t){n.program.drawTile(r,t)}))};var M=function(t){return 0==(t&t-1)},D=function(t,e,r){this.msgbus=t,this.worker_helper=r,this.texture_root_href=e,this.buffer=null,this.texture=null,this.textureCoordBuffer=null,this.polygon_triangleVertexPosBufr=null,this.line_triangleVertexPosBufr=null,this.displacementBuffer=null};D.prototype.load=function(t,e){t.endsWith("obj")||1==t.endsWith("obj?raw=true")?this.load_ssc_tile(t,e):1==t.endsWith("json")?this.load_image_tile(t,e):console.error("unknown url type: "+t)},D.prototype.load_ssc_tile=function(t,e){var r=this;this.worker_helper.send(t,(function(t){function n(t,e,r){var n=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),n.itemSize=r,n.numItems=e.length/r,n}e.bindFramebuffer(e.FRAMEBUFFER,e.fbo),r.polygon_triangleVertexPosBufr=n(e,new Float32Array(t[0]),6),e.bindFramebuffer(e.FRAMEBUFFER,null),r.line_triangleVertexPosBufr=n(e,new Float32Array(t[1]),4),r.displacementBuffer=n(e,new Float32Array(t[2]),2),r.msgbus.publish("data.tile.loaded","tile.ready")}))},D.prototype.load_image_tile=function(t,e){var r=this;!function(){r.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texture);var n=e.RGBA,o=e.RGBA,i=e.UNSIGNED_BYTE,a=new Uint8Array([255,255,255,0]);e.texImage2D(e.TEXTURE_2D,0,n,1,1,0,o,i,a),r.textureCoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r.textureCoordBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,1,0,0,1,1,1,0]),e.STATIC_DRAW),fetch(t).then((function(t){return t.json()})).then((function(t){r._process_image_tile(t,e)})).catch((function(t){console.error(t)}))}()},D.prototype._process_image_tile=function(t,e){var r=this,n=[];t.points.forEach((function(t){return n.push.apply(n,t)})),this._upload_image_tile_mesh(e,new Float32Array(n));var o=t.texture_href.split(".")[0].split("/"),i=+o[0],a=Math.pow(2,i),s=+o[1],u=+o[2],l="https://geodata.nationaalgeoregister.nl/tiles/service/wmts?&layer=brtachtergrondkaart&style=default&tileMatrixSet=EPSG:28992&service=WMTS&request=GetTile&version=1.0.0&format=image/png";fetch(l+="&TileCol="+s+"&TileRow="+(a-u)+"&tileMatrix="+i,{mode:"cors"}).then((function(t){if(!t.ok)throw t;return t.blob()})).then((function(t){return createImageBitmap(t)})).then((function(t){r.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),M(t.width)&&M(t.height)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),r.msgbus.publish("data.tile.loaded","tile.loaded.texture")})).catch((function(t){console.error(t)}))},D.prototype._upload_image_tile_mesh=function(t,e){this.buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),this.buffer.numItems=e.length/3},D.prototype.destroy=function(t){[this.buffer,this.textureCoordBuffer,this.line_triangleVertexPosBufr,this.displacementBuffer,this.polygon_triangleVertexPosBufr].forEach((function(e){null!==e&&(t.deleteBuffer(e),e=null)})),[this.texture].forEach((function(e){t.deleteTexture(e),e=null}))};var U=function(t,e){this.msgbus=t,this.tree=null,this.tree_setting=e,this.states=null,this.if_snap=!1;var r=window.navigator.hardwareConcurrency||2;this.worker_helpers=[];for(var n=0;n<r+1;n++)this.worker_helpers.push(new X);console.log(r+" workers made"),this.helper_idx_current=-1};function I(t,e,r){return void 0===r&&(r=null),e[function(t,e,r){void 0===r&&(r=null);var n=0,o=e.length-1;if(t<e[0])return 0;if(t>e[o])return o;for(;n<=o;){var i=Math.floor((n+o)/2);if(e[i]==t)return i;e[i]<t?n=i+1:o=i-1}if("floor"==r)return o;if("ceil"==r)return n;var a=(e[n]+e[o])/2;return"zoom_mid"==r&&(a=Math.sqrt(e[n]*e[o])),t<=a?o:n}(t,e,r)]}function N(t){for(var e=[],r=[t];r.length>0;){var n=r.pop();!0===n.hasOwnProperty("children")&&n.children.forEach((function(t){r.push(t)})),!0===n.hasOwnProperty("dataelements")&&n.dataelements.forEach((function(t){e.push(t)}))}return e}function k(t,e){for(var r=[],n=[t],o=function(){var t=n.pop();!0===t.hasOwnProperty("children")&&t.children.forEach((function(r){O(t.box,e)&&n.push(r)})),!0===t.hasOwnProperty("dataelements")&&t.dataelements.forEach((function(t){O(t.box,e)&&r.push(t)}))};n.length>0;)o();return r}function O(t,e){for(var r=t,n=!0,o=0;o<3;o++){var i=o+3;if(r[i]<=e[o]||r[o]>e[i]){n=!1;break}}return n}function z(t){var e=t[0],r=t[1];return[e+.5*(t[3]-e),r+.5*(t[4]-r)]}U.prototype.load=function(){var t=this,e=[0];null!=this.tree_setting.step_event_exc_link&&(this.if_snap=!0,fetch(this.tree_setting.step_event_exc_link).then((function(t){return t.json()})).then((function(t){for(var r=t.face_num,n=t.parallel_param,o=t.step_event_exceptions,i=0,a=1;r>1;){var s=Math.ceil(r*n);i<o.length&&o[i][0]==a&&(s=o[i][1],i+=1),e.push(e[e.length-1]+s),a+=1,r-=s}})).then((function(){console.log("ssctree.js states:",e)})).catch((function(){e=null}))),fetch(this.tree_setting.tree_root_href+this.tree_setting.tree_root_file_nm).then((function(t){return t.json()})).then((function(r){if(t.tree=r,N(r).forEach((function(e){e.content=null,e.last_touched=null,e.url=t.tree_setting.tile_root_href+e.href,e.loaded=!1})),0==t.if_snap)for(var n=r.metadata.no_of_steps_Ns,o=0;o<n;o++)e.push(e[e.length-1]+1)})).then((function(){t.msgbus.publish("data.tree.loaded",["tree.ready",t])})).catch((function(t){console.error(t)})),this.states=e},U.prototype.get_relevant_tiles=function(e,r){return null===this.tree?[]:(this.fetch_tiles(e,r),k(this.tree,e).map((function(e){return e.last_touched=t(),e})))},U.prototype.prepare_matrix=function(t,e){var r=e.world_square,n=-.5;return r[10]=-2/(t-n),r[14]=(t+n)/(t-n),r},U.prototype.fetch_tiles=function(e,r){var n=this;if(null!==this.tree){(function(t,e){var r=[],n=[t];for(;n.length>0;){var o=n.pop();!0===o.hasOwnProperty("children")&&o.children.forEach((function(t){t.hasOwnProperty("children")?n.push(t):t.hasOwnProperty("uri")&&!t.hasOwnProperty("loaded")&&O(t.box,e)&&(r.push(t),t.loaded=!0)}))}return r})(this.tree,e).map((function(t){n.load_subtree(t)}));var o=k(this.tree,e),i=[];o.map((function(t){!1===t.loaded&&i.push(t)})),(i=i.map((function(t){return[(r=t.box,n=e,o=z(r),i=z(n),a=Math.pow(i[0]-o[0],2),s=Math.pow(i[1]-o[1],2),Math.sqrt(a+s)),t];var r,n,o,i,a,s}))).sort((function(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:0})),(i=i.map((function(t){return t[1]}))).map((function(e){n.helper_idx_current=(n.helper_idx_current+1)%n.worker_helpers.length;var o=new D(n.msgbus,n.tree_setting.texture_root_href,n.worker_helpers[n.helper_idx_current]);o.load(e.url,r),e.content=o,e.loaded=!0,e.last_touched=t()}))}},U.prototype.load_subtree=function(t){var e=this;fetch(this.tree_setting.tree_root_href+t.uri).then((function(t){return t.json()})).then((function(r){t.children=r.children,N(t).forEach((function(t){t.content=null,t.last_touched=null,t.url=e.tree_setting.tile_root_href+t.info,t.loaded=!1})),e.msgbus.publish("data.tree.loaded","tree.ready")})).catch((function(t){console.error(t)}))},U.prototype.get_step_from_St=function(t){if(null===this.tree)return 0;var e=1-Math.pow(this.tree.metadata.start_scale_Sb/t,2);return this.tree.metadata.no_of_objects_Nb*e},U.prototype.get_zoom_snappedstep_from_St=function(t,e){void 0===e&&(e=1);var r=null;return e<1&&(r="ceil"),e>1&&(r="floor"),this.get_snappedstep_from_St(t,r)},U.prototype.get_snappedstep_from_St=function(t,e){if(void 0===e&&(e=null),null===this.tree)return 0;var r=this.get_step_from_St(t),n=r,o=this.states;return 1==this.if_snap&&r>o[0]-1e-4&&r<o[o.length-1]+1e-4&&(n=this.snap_state(r,e)),n},U.prototype.snap_state=function(t,e){return void 0===e&&(e=null),I(t,this.states,e)},U.prototype.get_time_factor=function(t,e,r){if(null===this.tree)return 1;var n=this.get_step_from_St(t),o=n,i=this.states,a=1;if(1==this.if_snap&&n>i[0]-1e-4&&n<i[i.length-1]+1e-4){var s=Math.abs(n-r);1==e?o=this.snap_state(n,null):e<1?o=this.snap_state(n,"ceil"):e>1&&(o=this.snap_state(n,"floor")),a=Math.abs(o-r)/s}return a},U.prototype.get_St_from_step=function(t){var e=this.tree.metadata.no_of_objects_Nb;return this.tree.metadata.start_scale_Sb*Math.pow(e/(e-t),.5)};var X=function(){var t=this;this.tasks={},this.worker=new Worker("worker.js"),this.worker.onmessage=function(e){t.receive(e)}};X.prototype.send=function(t,e){var r=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.tasks[r]=e,this.worker.postMessage({id:r,msg:t})},X.prototype.receive=function(t){var e=t.data.id,r=t.data.msg;this.tasks[e](r),delete this.tasks[e]};var q=function(e,r){var n=this;void 0===r&&(r=!1),this.ssctrees=[],this.map_setting=e;var a,s,u=e.tree_settings,l=e.canvas_nm;if(this._container="string"==typeof l?window.document.getElementById(l):l,!this._container)throw new Error("Container '"+l+"' not found.");this.canvasnm_in_cbnm=r,this._action="zoomAnimated",this._abort=null,this._transform=new c(e.initialization.center2d,[this._container.width,this._container.height],e.initialization.scale_den),this._interaction_settings={zoom_factor:1,zoom_duration:1,time_factor:1,pan_duration:1},this.msgbus=new E,this.msgbus.subscribe("data.tile.loaded",(function(t,e,r){n.renderWmts()})),this.msgbus.subscribe("data.tree.loaded",(function(t,e,r){n.panAnimated(0,0)})),this.msgbus.subscribe("settings.boundary-width",(function(t,e,r){n.renderer.settings.boundary_width=parseFloat(e),n.abortAndRender()})),this.msgbus.subscribe("settings.zoom-factor",(function(t,e,r){n._interaction_settings.zoom_factor=parseFloat(e)})),this.msgbus.subscribe("settings.zoom-duration",(function(t,e,r){n._interaction_settings.zoom_duration=parseFloat(e)})),this.msgbus.subscribe("settings.pan-duration",(function(t,e,r){n._interaction_settings.pan_duration=parseFloat(e)})),this.subscribe_scale(),u.forEach((function(t){n.ssctrees.push(new U(n.msgbus,t))})),this.msgbus.subscribe("go-to-start",(function(t,r,o){var i=n.getTransform(),a=e.initialization.center2d,s=e.initialization.scale_den,u=i.viewport.xmax,l=i.viewport.ymax;i.initTransform(a,[u,l],s),n.abortAndRender()})),this.gl=this.getWebGLContext(),function(t,e,r){var n,o,i,a=function(){return n&&t.deleteFramebuffer(n),o&&t.deleteTexture(o),i&&t.deleteRenderbuffer(i),null};if(!(n=t.createFramebuffer()))return console.log("Failed to create frame buffer object"),a();if(!(o=t.createTexture()))return console.log("Failed to create texture object"),a();if(t.bindTexture(t.TEXTURE_2D,o),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,r,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),n.texture=o,!(i=t.createRenderbuffer()))return console.log("Failed to create renderbuffer object"),a();t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,r),n.depthBuffer=i,t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,o,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if(t.FRAMEBUFFER_COMPLETE!==s)return console.log("Frame buffer object is incomplete: "+s.toString()),a();t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.fbo=n}(this.gl,this._container.width,this._container.height),this.renderer=new b(this.gl,this._container,this.ssctrees),function(t){var e=t.getCanvasContainer();e.addEventListener("mousedown",n,{passive:!1}),e.oncontextmenu=function(t){t.preventDefault()};var r=null;function n(s){s.preventDefault(),e.removeEventListener("mousedown",n,{passive:!1}),e.addEventListener("mousemove",i,{passive:!1}),e.addEventListener("mouseup",a,{passive:!1});var u=e.getBoundingClientRect(),l=s.touches?s.touches[0]:s,h=l.clientX-u.left-e.clientLeft,c=l.clientY-u.top-e.clientTop;r=new o([h,c]),t.panBy(0,0)}function i(n){n.preventDefault();var o=e.getBoundingClientRect(),i=n.touches?n.touches[0]:n,a=i.clientX-o.left-e.clientLeft,s=i.clientY-o.top-e.clientTop,u=r.last()[1],l=a-u[0],h=s-u[1];r.shift(200),r.push([a,s]),t.panBy(l,h)}function a(o){e.removeEventListener("mousemove",i,{passive:!1}),e.removeEventListener("mouseup",a,{passive:!1}),e.addEventListener("mousedown",n,{passive:!1});var s=e.getBoundingClientRect(),u=o.changedTouches?o.changedTouches[0]:o,l=u.clientX-s.left-e.clientLeft,h=u.clientY-s.top-e.clientTop;r.shift(200),r.push([l,h]);var c=r.last(),f=r.first(),p=(c[0]-f[0])/1e3,d=f[1],g=(l-d[0])/p*1,_=(h-d[1])/p*1,m=parseFloat(t._interaction_settings.pan_duration),v=.5*g*m,E=.5*_*m;r=null,t.panAnimated(v,E)}}(this),function(e){var r=e,n=e.getCanvasContainer();n.addEventListener("wheel",u,{passive:!1}),n.addEventListener("mousewheel",u,{passive:!1});var a=null,s=null;function u(e){e.preventDefault();var u=t();if(!(u-s<20)){var l=void 0;if("wheel"===e.type?l=e.deltaY:"mousewheel"===e.type&&(l=-e.wheelDeltaY),0!==l){s=u;var h=.1,c=Math.max(-1,Math.min(1,-l));if(null===a)a=new o(c);else{var f=u-a.last()[0];switch(a.push(c),!0){case f>750:h=.0625;break;case f>500:h=.125;break;case f>50:h=.25;break;default:h=.5}h*=i(),a.shift(2e3)}var p=n.getBoundingClientRect(),d=e.clientX-p.left-n.clientLeft,g=e.clientY-p.top-n.clientTop;switch(c){case 1:r.zoomInAnimated(d,g,h);break;case-1:r.zoomOutAnimated(d,g,h)}}}}}(this),s=(a=this).getCanvasContainer(),document.getElementById("zoomInButton").addEventListener("click",(function(){a.zoomInAnimated(s.width/2,s.height/2,i())})),document.getElementById("zoomOutButton").addEventListener("click",(function(){a.zoomOutAnimated(s.width/2,s.height/2,i())})),function(e){var r=e.getCanvasContainer();function n(t){var e=a(t),r=e[0],n=e[1];return Math.sqrt(r*r,n*n)}function i(t){var e=a(t),r=e[0],n=e[1],o=t[0];return[o[0]+r/2,o[1]+n/2]}function a(t){return[t[1][0]-t[0][0],t[1][1]-t[0][1]]}function s(t){for(var e=r.getBoundingClientRect(),n=t.touches,o=[],i=0;i<2;i++){var a=n[i].clientX-e.left-r.clientLeft,s=n[i].clientY-e.top-r.clientTop;o.push([a,s])}return o}r.addEventListener("touchstart",c,!1),r.oncontextmenu=function(t){t.preventDefault()};var u=null,l=null,h=null;function c(n){if(n.touches&&2===n.touches.length){n.preventDefault(),r.removeEventListener("touchstart",c,!1),r.addEventListener("touchmove",f,{capture:!0,passive:!1}),r.addEventListener("touchend",p,!1),u=null,l=t(),console.log("start touch with 2 fingers "+l),e.abortAndRender();var i=s(n);h=new o(i)}}function f(r){if(r.touches&&2===r.touches.length&&!(t()-l<30)){console.log("time of touch "+(t()-l)),r.preventDefault();var o=s(r);h.shift(200),h.push(o);var a=n(o);if(null!==u){var c=a/u,f=i(o),p=f[0],d=f[1];e.zoom(p,d,Math.max(Math.min(c,1.1),.9))}u=a}}function p(t){if(0===t.touches.length){if(t.preventDefault(),console.log("end"),r.removeEventListener("touchmove",f,{capture:!0,passive:!1}),r.removeEventListener("touchend",p,!1),r.addEventListener("touchstart",c,!1),u=null,l=null,console.log("trace for pinch end "+h.length()),h.length()>1){var o=h.last(),a=h.lastbutone(),s=n(o[1]),d=n(a[1]),g=i(o[1]),_=g[0],m=g[1];s<d?e.zoomOutAnimated(_,m,.5):e.zoomInAnimated(_,m,.5)}h=null}}}(this),function(t){var e=t.getCanvasContainer();function r(t){var r=e.getBoundingClientRect(),n=t.touches;return[n[0].clientX-r.left-e.clientLeft,n[0].clientY-r.top-e.clientTop]}e.addEventListener("touchstart",a,!1),e.oncontextmenu=function(t){t.preventDefault()};var n=null,i=null;function a(t){if(!(t.touches.length>1)){t.preventDefault(),e.removeEventListener("touchstart",a,!1),e.addEventListener("touchmove",s,{capture:!0,passive:!1}),e.addEventListener("touchend",u,!1);var l=r(t);n=new o(l),i="pending"}}function s(e){if(e.touches.length>1)i="pending";else{e.preventDefault();var o=r(e),a=n.last()[1],s=o[0]-a[0],u=o[1]-a[1];switch(n.shift(200),n.push(o),i){case"pending":(Math.sqrt(s*s,u*u)>=3||n.last()[0]-n.first()[0]>60)&&(i="active");break;case"active":t.panBy(s,u)}}}function u(r){if(0===r.touches.length){switch(e.removeEventListener("touchmove",s,{capture:!0,passive:!1}),e.removeEventListener("touchend",u,!1),e.addEventListener("touchstart",a,!1),n.shift(200),n.length()<=2&&(i="pending"),i){case"pending":console.log("touch drag end - SKIP");break;case"active":var o=n.last(),l=n.first(),h=(o[0]-l[0])/1e3,c=l[1],f=(o[1][0]-c[0])/h*1,p=(o[1][1]-c[1])/h*1,d=parseFloat(t._interaction_settings.pan_duration),g=.5*f*d,_=.5*p*d;console.log("touch drag end - ANIMATE"),console.log([g,_]),t.panAnimated(g,_)}i="pending",n=null,console.log("touchend")}}}(this),this.mapTilesRenderer=new P(this.getWebGLContext(),this.msgbus);var h=this.getTransform().getScaleDenominator();this.msgbus.publish("map.scale",[this.getTransform().getCenterWorld(),h])};q.prototype.loadTree=function(){this.ssctrees.forEach((function(t){t.load()}))},q.prototype.getCanvasContainer=function(){return this._container},q.prototype.getWebGLContext=function(){return this.getCanvasContainer().getContext("webgl",{antialias:!0,alpha:!1,premultipliedAlpha:!1})},q.prototype.getTransform=function(){return this._transform},q.prototype.render=function(t){void 0===t&&(t=0);var e=this.ssctrees,r=this.getTransform().getScaleDenominator(),n=r,o=[],i=[],a=[],s=this.getTransform().snapped_step,u=this.getTransform().snapped_St;if(0==e[0].if_snap){var l=this.deal_without_snapstate(r,this.ssctrees);o=l.steps,i=l.local_statelows,a=l.local_statehighs}else{1==t&&"zoomAnimated"==this._action&&s!=Number.MAX_SAFE_INTEGER?(n=u,o.push(s),i.push(s),a.push(s)):(o.push(e[0].get_step_from_St(n)),i.push(e[0].snap_state(o[0],"floor")),a.push(e[0].snap_state(o[0],"ceil")));for(var h=1;h<e.length;h++)o.push(e[h].get_step_from_St(n)),i.push(e[h].snap_state(o[h],"floor")),a.push(e[h].snap_state(o[h],"ceil"))}this.msgbus.publish("map.scale",[this.getTransform().getCenterWorld(),n]),this.renderer.render_ssctrees(o,this.getTransform(),n,i,a),this.renderWmts()},q.prototype.renderWmts=function(){var t=this.getTransform(),e=t.getVisibleWorld(),r=t.getScaleDenominator(),n=[e.xmin,e.ymin,e.xmax,e.ymax],o=this.getTransform().world_square;this.mapTilesRenderer.update(n,r,o)},q.prototype.deal_without_snapstate=function(t,e){for(var r=[],n=[],o=[],i=0;i<e.length;i++){var a=t,s=this.map_setting.tree_settings[i].discrete_scales;null!=s&&(a=I(t,s,this.map_setting.tree_settings[i].snap_style)),r.push(e[i].get_step_from_St(a)),n.push(e[i].snap_state(r[i],"floor")),o.push(e[i].snap_state(r[i],"ceil"))}return{steps:r,local_statelows:n,local_statehighs:o}},q.prototype.doEaseNone=function(t,e){var r=this;return function(n){for(var o=new Float64Array(16),i=0;i<16;i++){var a=t[i]+n*(e[i]-t[i]);o[i]=a}r.getTransform().world_square=o,r.getTransform().updateViewportTransform(),r.render(n),1==n&&(r._abort=null)}},q.prototype.doEaseInOutSine=function(t,e){return function(r){for(var n=new Float64Array(16),o=Math.cos(Math.PI*r)+1,i=0;i<16;i++){var a=.5*(e[i]-t[i])*o+t[i];n[i]=a}this.getTransform().world_square=n,this.getTransform().updateViewportTransform(),this.render(r),1==r&&(this._abort=null)}},q.prototype.doEaseOutSine=function(t,e){var r=this;return function(n){for(var o=new Float64Array(16),i=Math.sin(n*Math.PI*.5),a=0;a<16;a++){var s=(e[a]-t[a])*i+t[a];o[a]=s}r.getTransform().world_square=o,r.getTransform().updateViewportTransform(),r.render(n),1===n&&(r._abort=null)}},q.prototype.doEaseOutQuint=function(t,e){return function(r){for(var n=r-1,o=Math.pow(n,5)+1,i=new Float64Array(16),a=0;a<16;a++){var s=(e[a]-t[a])*o+t[a];i[a]=s}this.getTransform().world_square=i,this.getTransform().updateViewportTransform(),this.render(r),1==r&&(this._abort=null)}},q.prototype.animateZoom=function(t,e,r){var n=this.getTransform().world_square;this._interaction_settings.time_factor=this.getTransform().compute_zoom_parameters(this.ssctrees[0],r,t,this.getCanvasContainer().getBoundingClientRect().height-e,this.ssctrees[0].if_snap);var o=this.getTransform().world_square;return this.doEaseOutSine(n,o)},q.prototype.animatePan=function(t,e){var r=this.getTransform().world_square;this.getTransform().pan(t,-e);var n=this.getTransform().world_square;return this.doEaseOutSine(r,n)},q.prototype.jumpTo=function(t,e,r){var n=[t,e],o=this.getCanvasContainer(),i=[o.width,o.height],a=r;this.getTransform().initTransform(n,i,a),this.abortAndRender()},q.prototype.flyTo=function(t,e,r){var o=this,i=[t,e],a=r,s=this.getTransform(),u=s.getVisibleWorld().center(),l=s.getScaleDenominator(),h=this.getCanvasContainer(),c=[h.width,h.height],f=R(u,l,c,i,a,10);this._abort=n((function(t){var e=f(t);o.getTransform().initTransform(e[0],c,e[1]),o.renderWmts(),o.msgbus.publish("map.scale",[o.getTransform().getCenterWorld(),o.getTransform().getScaleDenominator()])}),10,this)},q.prototype.panBy=function(t,e){null!==this._abort&&this._abort(),this.getTransform().pan(t,-e),this.render()},q.prototype.zoom=function(t,e,r){this._interaction_settings.time_factor=this.getTransform().compute_zoom_parameters(this.ssctrees[0],r,t,this.getCanvasContainer().getBoundingClientRect().height-e,this.ssctrees[0].if_snap),this.render()},q.prototype.abortAndRender=function(){null!==this._abort&&(this._abort(),this._abort=null),this.getTransform().pan(0,0),this.render()},q.prototype.zoomInAnimated=function(t,e,r){this.zoomAnimated(t,e,1+r*this._interaction_settings.zoom_factor)},q.prototype.zoomOutAnimated=function(t,e,r){this.zoomAnimated(t,e,1/(1+r*this._interaction_settings.zoom_factor))},q.prototype.zoomAnimated=function(t,e,r){null!==this._abort&&this._abort(),this._action="zoomAnimated";var o=this.animateZoom(t,e,r),i=this._interaction_settings.zoom_duration*this._interaction_settings.time_factor;this._abort=n(o,i,this)},q.prototype.panAnimated=function(t,e){null!==this._abort&&this._abort(),this._action="panAnimated";var r=this.animatePan(t,e);this._abort=n(r,this._interaction_settings.pan_duration,this)},q.prototype.resize=function(t,e){var r=this.getTransform(),n=r.getCenterWorld(),o=r.getScaleDenominator();r.initTransform(n,[t,e],o),this.renderer.setViewport(t,e);var i=this.gl,a=i.fbo;i.bindTexture(i.TEXTURE_2D,a.texture),i.bindRenderbuffer(i.RENDERBUFFER,a.depthBuffer),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null)},q.prototype.subscribe_scale=function(){var t=this.msgbus;t.subscribe("map.scale",(function(e,r,n){if(n===t.id){var o=Math.round(r[1]).toString().replace(/\B(?=(\d{3})+(?!\d))/g," ");document.getElementById("scale-denominator").textContent=" 1:"+o}}))};var G=function(t){this.map=t,this.createElements(),this.addEventListeners(),this.state={suggestions:[],highlight:-1},V()};G.prototype.createElements=function(){var t=document.createElement("input");t.setAttribute("id","search"),t.setAttribute("type","search"),t.setAttribute("placeholder","Search for a Dutch location..."),t.setAttribute("autocomplete","off");var e=document.createElement("button");e.setAttribute("id","clear-button"),e.setAttribute("type","button"),e.setAttribute("aria-label","clear"),e.innerHTML="&#10006;";var r=document.getElementById("geocode-placeholder");r.appendChild(t),r.appendChild(e);var n=document.createElement("div");n.style.position="relative";var o=document.createElement("div");o.setAttribute("id","name-output"),o.style.position="absolute",o.style.zIndex=1,n.appendChild(o),r.appendChild(n)},G.prototype.addEventListeners=function(){var t=this;document.getElementById("clear-button").addEventListener("click",(function(){var t=document.getElementById("search");t.value="",t.focus()}));var e=document.getElementById("search");e.addEventListener("input",(function(){!function(t,e){var r,n=this}(t.getSuggestions(e.value),500)})),e.addEventListener("keyup",(function(e){t.onKeyUp(e)}))},G.prototype.getSuggestions=function(t){var e=this;this.pdokRequestSuggest(t).then((function(t){e.onSuggestReponse(t)}))},G.prototype.pdokRequestSuggest=async function(t,e){var r={q:t,fq:"*"};e&&Object.assign(r,e);var n=await fetch("https://geodata.nationaalgeoregister.nl/locatieserver/v3/suggest"+W({query:r}));if(!n.ok)throw new Error("Response from locatieserver suggest endpoint not ok");return await n.json()},G.prototype.onSuggestReponse=function(t){this.state.suggestions=this.parseSuggestReponse(t),-1==this.state.highlight&&(this.state.highlight=0),this.displaySuggestions(this.state.suggestions),this.updateHighlight(),H()},G.prototype.parseSuggestReponse=function(t){for(var e=[],r=0,n=t.response.docs;r<n.length;r+=1){var o=n[r];"highlighting"in t&&"id"in o&&o.id in t.highlighting&&"suggest"in t.highlighting[o.id]&&t.highlighting[o.id].suggest.length>0&&e.push({id:o.id,suggestionHTML:t.highlighting[o.id].suggest[0],suggestion:o.weergavenaam,type:o.type})}return e},G.prototype.displaySuggestions=function(t){Y("name-output");for(var e=document.getElementById("name-output"),r=0,n=t;r<n.length;r+=1){var o=n[r],i=document.createElement("p");i.setAttribute("class","suggestion");var a=document.createElement("a");a.innerHTML=o.suggestion+" ["+o.type+"]",a.addEventListener("click",this.performLookupForId.bind(this,o),!1),i.appendChild(a),e.appendChild(i)}},G.prototype.performLookupForId=function(t){var e=this;document.getElementById("search").value=t.suggestion,this.pdokLookup(t.id).then((function(t){e.onLookupResult(t)})),Y("name-output")},G.prototype.pdokLookup=async function(t,e){var r={id:t};e&&Object.assign(r,e);var n=await fetch("https://geodata.nationaalgeoregister.nl/locatieserver/v3/lookup"+W({query:r}));if(!n.ok)throw new Error("Response from locatieserver lookup endpoint not ok");return await n.json()},G.prototype.onLookupResult=function(t){if("docs"in t.response&&t.response.docs.length>0){var e=t.response.docs[0].centroide_rd,r=e.slice(6,e.length-1).split(" ").map(Number),n=1e4;switch(t.response.docs[0].type){case"provincie":n=384e3;break;case"gemeente":case"waterschapsgrens":n=48e3;break;case"woonplaats":n=24e3;break;case"postcode":n=6e3;break;case"weg":case"adres":case"perceel":case"appartementsrecht":case"hectometerpaal":n=1500}this.map.flyTo(r[0],r[1],n),V(),this.state.suggestions=[],this.state.highlight=-1}},G.prototype.onKeyUp=function(t){switch(t.code){case"ArrowUp":this.onArrowUp();break;case"ArrowDown":this.onArrowDown();break;case"Enter":this.state.suggestions.length>0&&-1!=this.state.highlight&&this.onEnter()}},G.prototype.onEnter=function(){this.performLookupForId(this.state.suggestions[this.state.highlight],null)},G.prototype.onArrowDown=function(){this.state.highlight<this.state.suggestions.length-1?this.state.highlight++:this.state.suggestions.length>0&&(this.state.highlight=0),this.updateHighlight()},G.prototype.onArrowUp=function(){this.state.highlight>0?this.state.highlight--:this.state.suggestions.length>0&&(this.state.highlight=this.state.suggestions.length-1),this.updateHighlight()},G.prototype.updateHighlight=function(){for(var t=document.getElementById("name-output").childNodes,e=0;e<t.length;e++)t[e].classList.remove("is-active");t.length>0&&this.state.highlight>=0&&this.state.highlight<t.length&&t[this.state.highlight].classList.add("is-active")};var H=function(){document.getElementById("name-output").classList.remove("w3-hide")},V=function(){document.getElementById("name-output").classList.add("w3-hide")},W=function(t){var e="?";for(var r in t.query)e+=(e.length>1?"&":"")+r+"="+t.query[r];return e},Y=function(t){for(var e=document.getElementById(t),r=e.firstElementChild;r;)e.removeChild(r),r=e.firstElementChild};return{Map:q,MessageBusConnector:E,PdokSuggestWidget:G}}));
